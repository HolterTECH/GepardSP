{% extends "project_base.html" %}

{% block title %}–ì—Ä–∞—Ñ–∏–∫ –ì–∞–Ω—Ç–∞ - {{ project.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
<style>
    .gantt-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow-x: auto;
        margin-left: 0;
        width: calc(100vw - 280px); /* –£—á–∏—Ç—ã–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é */
        max-width: 100%;
    }

    /* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 768px) {
        .gantt-container {
            width: 100vw;
            margin-left: -20px;
            padding: 10px;
        }
    }
    
    .gantt-controls {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .gantt-info {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .view-mode-selector {
        display: flex;
        gap: 10px;
    }
    
    .view-mode-btn {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
        border-radius: 4px;
    }
    
    .view-mode-btn.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }
    
    .gantt-task-details {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
        border-left: 4px solid #3498db;
    }
    
    .milestone-marker {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .gantt-grid-header {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .gantt-stat-card {
        background: white;
        padding: 15px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .gantt-stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .gantt-stat-label {
        font-size: 12px;
        color: #7f8c8d;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <h1>–ì—Ä–∞—Ñ–∏–∫ –ì–∞–Ω—Ç–∞: {{ project.name }}</h1>
    <p>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ —Å –∑–∞–¥–∞—á–∞–º–∏ –∏ —Å—Ä–æ–∫–∞–º–∏</p>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ -->
<div class="gantt-grid-header">
    <div class="gantt-stat-card">
        <div class="gantt-stat-value" id="total-tasks">0</div>
        <div class="gantt-stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
    </div>
    <div class="gantt-stat-card">
        <div class="gantt-stat-value" id="project-duration">0 –¥–Ω.</div>
        <div class="gantt-stat-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞</div>
    </div>
    <div class="gantt-stat-card">
        <div class="gantt-stat-value" id="completed-tasks">0</div>
        <div class="gantt-stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
    </div>
    <div class="gantt-stat-card">
        <div class="gantt-stat-value" id="milestones-count">0</div>
        <div class="gantt-stat-label">–í–µ—Ö–∏</div>
    </div>
</div>

<!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
<div class="gantt-controls">
    <div class="view-mode-selector">
        <button class="view-mode-btn active" data-mode="Quarter Day">1/4 –î–Ω—è</button>
        <button class="view-mode-btn" data-mode="Half Day">1/2 –î–Ω—è</button>
        <button class="view-mode-btn" data-mode="Day">–î–µ–Ω—å</button>
        <button class="view-mode-btn" data-mode="Week">–ù–µ–¥–µ–ª—è</button>
        <button class="view-mode-btn" data-mode="Month">–ú–µ—Å—è—Ü</button>
    </div>
    
    <div style="flex: 1;"></div>
    
    <button class="btn" onclick="refreshGantt()" style="background-color: #27ae60;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    <button class="btn" onclick="exportGantt()" style="background-color: #e67e22;">üìä –≠–∫—Å–ø–æ—Ä—Ç</button>
    <button class="btn" onclick="toggleMilestones()" id="toggleMilestonesBtn" style="background-color: #FFD700;">‚≠ê –ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ö–∏</button>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –ì–∞–Ω—Ç–∞ -->
<div class="gantt-container">
    <div id="gantt-chart"></div>
</div>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–∞–¥–∞—á–µ -->
<div class="gantt-info">
    <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–µ</h3>
    <div id="task-details" class="gantt-task-details">
        –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π
    </div>
    
    <h3 style="margin-top: 30px;">–í–µ—Ö–∏ –ø—Ä–æ–µ–∫—Ç–∞</h3>
    <div id="milestones-list">
        {% for milestone in milestones %}
        <div class="milestone-item" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
            <span class="milestone-marker" style="background-color: {{ milestone.color }}"></span>
            <strong>{{ milestone.title }}</strong> - {{ milestone.date }}
            {% if milestone.description %}
            <br><small>{{ milestone.description }}</small>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
<div id="editTaskModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</h3>
        <form id="editTaskForm">
            <input type="hidden" id="editTaskId">
            
            <div class="form-group">
                <label for="editTaskName">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                <input type="text" id="editTaskName" required>
            </div>
            
            <div class="date-fields">
                <div class="field-group">
                    <label for="editTaskStart">–ù–∞—á–∞–ª–æ:</label>
                    <input type="date" id="editTaskStart" required>
                </div>
                <div class="field-group">
                    <label for="editTaskEnd">–û–∫–æ–Ω—á–∞–Ω–∏–µ:</label>
                    <input type="date" id="editTaskEnd" required>
                </div>
                <div class="field-group">
                    <label for="editTaskProgress">–ü—Ä–æ–≥—Ä–µ—Å—Å (%):</label>
                    <input type="number" id="editTaskProgress" min="0" max="100" required>
                </div>
            </div>
            
            <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
<script>
    let gantt = null;
    let currentViewMode = 'Day';
    let showMilestones = true;
    const PROJECT_ID = {{ project.id }};

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –ì–∞–Ω—Ç–∞
    document.addEventListener('DOMContentLoaded', function() {
        initGanttChart();
        initViewModeButtons();
        initEditForm();
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    async function initGanttChart() {
        try {
            const response = await fetch(`/api/project/${PROJECT_ID}/gantt/data`);
            const ganttData = await response.json();
            
            updateStatistics(ganttData);
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Frappe Gantt
            const tasks = ganttData.tasks.map(task => ({
                id: task.id.toString(),
                name: task.name,
                start: task.start,
                end: task.end,
                progress: task.progress,
                dependencies: task.dependencies ? task.dependencies.split(',').map(dep => dep.trim()).join(', ') : ''
            }));
            
            // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –ì–∞–Ω—Ç–∞
            gantt = new Gantt("#gantt-chart", tasks, {
                header_height: 50,
                column_width: 30,
                step: 24,
                view_modes: ['Quarter Day', 'Half Day', 'Day', 'Week', 'Month'],
                bar_height: 20,
                bar_corner_radius: 3,
                arrow_curve: 5,
                padding: 18,
                view_mode: currentViewMode,
                date_format: 'YYYY-MM-DD',
                custom_popup_html: null,
                on_click: function(task) {
                    showTaskDetails(task);
                },
                on_date_change: function(task, start, end) {
                    updateTaskDates(task.id, start, end);
                },
                on_progress_change: function(task, progress) {
                    updateTaskProgress(task.id, progress);
                }
            });
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≥—Ä–∞—Ñ–∏–∫–∞ –ì–∞–Ω—Ç–∞:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞ –ì–∞–Ω—Ç–∞');
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    function initViewModeButtons() {
        const buttons = document.querySelectorAll('.view-mode-btn');
        buttons.forEach(btn => {
            btn.addEventListener('click', function() {
                // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                buttons.forEach(b => b.classList.remove('active'));
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–µ
                this.classList.add('active');
                // –ú–µ–Ω—è–µ–º —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                currentViewMode = this.dataset.mode;
                gantt.change_view_mode(currentViewMode);
            });
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function initEditForm() {
        document.getElementById('editTaskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveTaskChanges();
        });
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏
    function showTaskDetails(task) {
        const detailsDiv = document.getElementById('task-details');
        detailsDiv.innerHTML = `
            <h4>${task.name}</h4>
            <p><strong>–ü–µ—Ä–∏–æ–¥:</strong> ${formatDate(task.start)} - ${formatDate(task.end)}</p>
            <p><strong>–ü—Ä–æ–≥—Ä–µ—Å—Å:</strong> ${task.progress}%</p>
            <p><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${calculateDuration(task.start, task.end)} –¥–Ω–µ–π</p>
            ${task.dependencies ? `<p><strong>–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:</strong> ${task.dependencies}</p>` : ''}
            <button class="btn" onclick="openEditModal('${task.id}')" style="margin-top: 10px;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        `;
    }

    // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    async function openEditModal(taskId) {
        try {
            const response = await fetch(`/api/task/${taskId}`);
            const task = await response.json();
            
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTaskName').value = task.title;
            document.getElementById('editTaskStart').value = task.start_date;
            document.getElementById('editTaskEnd').value = task.end_date;
            document.getElementById('editTaskProgress').value = task.status === 'completed' ? 100 : 
                                                               task.status === 'in_progress' ? 50 : 0;
            
            document.getElementById('editTaskModal').style.display = 'block';
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á–∏');
        }
    }

    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function closeEditModal() {
        document.getElementById('editTaskModal').style.display = 'none';
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
    async function saveTaskChanges() {
        const taskId = document.getElementById('editTaskId').value;
        const name = document.getElementById('editTaskName').value;
        const start = document.getElementById('editTaskStart').value;
        const end = document.getElementById('editTaskEnd').value;
        const progress = parseInt(document.getElementById('editTaskProgress').value);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        const status = progress === 100 ? 'completed' : 
                      progress > 0 ? 'in_progress' : 'planned';
        
        try {
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            const updateResponse = await fetch(`/api/task/${taskId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: name, description: '' })
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—ã –∏ —Å—Ç–∞—Ç—É—Å
            const datesResponse = await fetch(`/api/task/${taskId}/dates`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    start_date: start, 
                    end_date: end 
                })
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            const statusResponse = await fetch(`/api/task/${taskId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            });
            
            if (updateResponse.ok && datesResponse.ok && statusResponse.ok) {
                closeEditModal();
                refreshGantt();
                alert('–ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
            } else {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π');
        }
    }

    // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏ (–ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ)
    async function updateTaskDates(taskId, start, end) {
        try {
            const response = await fetch(`/api/task/${taskId}/dates`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    start_date: start, 
                    end_date: end 
                })
            });
            
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞—Ç');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞—Ç:', error);
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ UI
        }
    }

    // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–¥–∞—á–∏
    async function updateTaskProgress(taskId, progress) {
        const status = progress === 100 ? 'completed' : 
                      progress > 0 ? 'in_progress' : 'planned';
        
        try {
            const response = await fetch(`/api/task/${taskId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            });
            
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
        }
    }

    // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    function updateStatistics(ganttData) {
        document.getElementById('total-tasks').textContent = ganttData.tasks.length;
        document.getElementById('milestones-count').textContent = ganttData.milestones.length;
        
        // –°—á–∏—Ç–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
        const completedTasks = ganttData.tasks.filter(task => task.status === 'completed').length;
        document.getElementById('completed-tasks').textContent = completedTasks;
        
        // –°—á–∏—Ç–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞
        if (ganttData.tasks.length > 0) {
            const startDates = ganttData.tasks.map(task => new Date(task.start));
            const endDates = ganttData.tasks.map(task => new Date(task.end));
            const projectStart = new Date(Math.min(...startDates));
            const projectEnd = new Date(Math.max(...endDates));
            const duration = Math.ceil((projectEnd - projectStart) / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById('project-duration').textContent = duration + ' –¥–Ω.';
        }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('ru-RU');
    }

    function calculateDuration(start, end) {
        const startDate = new Date(start);
        const endDate = new Date(end);
        return Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
    }

    // –î–µ–π—Å—Ç–≤–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    function refreshGantt() {
        initGanttChart();
    }

    function exportGantt() {
        // –ü—Ä–æ—Å—Ç–æ–π —ç–∫—Å–ø–æ—Ä—Ç –≤ PNG
        const ganttElement = document.querySelector('#gantt-chart svg');
        if (ganttElement) {
            const svgData = new XMLSerializer().serializeToString(ganttElement);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                const pngFile = canvas.toDataURL('image/png');
                const downloadLink = document.createElement('a');
                downloadLink.download = `gantt-${PROJECT_ID}-${new Date().toISOString().split('T')[0]}.png`;
                downloadLink.href = pngFile;
                downloadLink.click();
            };
            
            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
        } else {
            alert('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫');
        }
    }

    function toggleMilestones() {
        showMilestones = !showMilestones;
        const btn = document.getElementById('toggleMilestonesBtn');
        btn.textContent = showMilestones ? '‚≠ê –°–∫—Ä—ã—Ç—å –≤–µ—Ö–∏' : '‚≠ê –ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ö–∏';
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —Å–∫—Ä—ã—Ç–∏—è/–ø–æ–∫–∞–∑–∞ –≤–µ—Ö –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    window.onclick = function(event) {
        const modal = document.getElementById('editTaskModal');
        if (event.target == modal) {
            closeEditModal();
        }
    }
</script>
{% endblock %}