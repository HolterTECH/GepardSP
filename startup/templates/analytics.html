{% extends "project_base.html" %}

{% block content %}
<div class="analytics-container">
    <div class="analytics-header">
        <h1>üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ "{{ project.name }}"</h1>
        <p>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–∞–Ω–¥—ã –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞—á</p>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ -->
    <div id="loadingMessage" class="loading-message">
        <p>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...</p>
    </div>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
    <div class="analytics-section" id="workloadSection" style="display: none;">
        <h2>üìä –ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥—ã</h2>
        <div class="workload-stats">
            <div class="stat-card">
                <h3>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div id="workloadSummary" class="stats-grid">
                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="workload-charts">
            <div class="chart-container">
                <h3>–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∫–∏ (%)</h3>
                <div class="chart-wrapper">
                    <canvas id="workloadChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>–°–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º</h3>
                <div class="chart-wrapper">
                    <canvas id="complexityChart"></canvas>
                </div>
            </div>
        </div>

        <div class="workload-details">
            <h3>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º</h3>
            <div id="workloadDetails" class="details-grid">
                <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
    </div>

    <!-- –°–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á -->
    <div class="analytics-section" id="complexitySection" style="display: none;">
        <h2>‚öñÔ∏è –°–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á –ø—Ä–æ–µ–∫—Ç–∞</h2>
        <div class="complexity-stats">
            <div class="stat-card">
                <h3>–û–±—â–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å</h3>
                <div id="complexitySummary" class="stats-grid">
                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
        </div>

        <div class="complexity-charts">
            <div class="chart-container">
                <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ –∑–∞–¥–∞—á–∞–º</h3>
                <div class="chart-wrapper">
                    <canvas id="tasksComplexityChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>–°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º</h3>
                <div class="chart-wrapper">
                    <canvas id="priorityComplexityChart"></canvas>
                </div>
            </div>
        </div>

        <div class="complexity-details">
            <h3>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∑–∞–¥–∞—á–∞–º</h3>
            <table id="complexityTable" class="analytics-table">
                <thead>
                    <tr>
                        <th>–ó–∞–¥–∞—á–∞</th>
                        <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                        <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                        <th>–°–ª–æ–∂–Ω–æ—Å—Ç—å</th>
                        <th>–í–∫–ª–∞–¥ –≤ –ø—Ä–æ–µ–∫—Ç</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
    <div id="errorMessage" class="error-message" style="display: none;">
        <h3>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h3>
        <p id="errorText">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.</p>
        <button onclick="location.reload()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
window.analytics = window.analytics || {
    track: function(eventName, properties) { 
        console.log('[Analytics Stub] Track:', eventName, properties); 
    },
    identify: function(userId, traits) { 
        console.log('[Analytics Stub] Identify:', userId, traits); 
    },
    page: function(category, name, properties) { 
        console.log('[Analytics Stub] Page:', category, name, properties); 
    }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
let analyticsManager = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...');
    
    // –ü–æ–ª—É—á–∞–µ–º ID –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ URL
    const pathParts = window.location.pathname.split('/');
    const projectId = parseInt(pathParts[2]);
    
    if (isNaN(projectId)) {
        console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø—Ä–æ–µ–∫—Ç–∞');
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç');
        return;
    }
    
    console.log(`üìÅ Project ID: ${projectId}`);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    analyticsManager = new AnalyticsManager(projectId);
});

function showError(message) {
    document.getElementById('loadingMessage').style.display = 'none';
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').style.display = 'block';
}

class AnalyticsManager {
    constructor(projectId) {
        this.projectId = projectId;
        this.workloadData = [];
        this.complexityData = [];
        this.init();
    }

    init() {
        console.log(`üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ ${this.projectId}`);
        this.hideError();
        this.showLoading();
        this.loadWorkloadData();
        this.loadComplexityData();
    }

    async loadWorkloadData() {
        try {
            console.log(`üìä –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–∫–∏...`);
            const response = await fetch(`/api/project/${this.projectId}/analytics/workload`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏:', data);
            
            if (data.success) {
                this.workloadData = data.workload_data || [];
                this.renderWorkloadCharts();
                this.renderWorkloadDetails();
                this.checkDataAndShowSections();
            } else {
                throw new Error(data.error || 'Unknown error');
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            this.showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
        }
    }

    async loadComplexityData() {
        try {
            console.log(`‚öñÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–ª–æ–∂–Ω–æ—Å—Ç–∏...`);
            const response = await fetch(`/api/project/${this.projectId}/analytics/complexity`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            console.log('–î–∞–Ω–Ω—ã–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:', data);
            
            if (data.success) {
                this.complexityData = data.complexity_data || [];
                this.renderComplexityCharts();
                this.renderComplexityTable();
                this.checkDataAndShowSections();
            } else {
                throw new Error(data.error || 'Unknown error');
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:', error);
            this.showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: ' + error.message);
        }
    }

    checkDataAndShowSections() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
        const hasWorkloadData = this.workloadData && this.workloadData.length > 0;
        const hasComplexityData = this.complexityData && this.complexityData.length > 0;
        
        console.log(`üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö: workload=${hasWorkloadData}, complexity=${hasComplexityData}`);
        
        if (hasWorkloadData || hasComplexityData) {
            this.hideLoading();
            this.hideError();
            
            if (hasWorkloadData) {
                document.getElementById('workloadSection').style.display = 'block';
            }
            if (hasComplexityData) {
                document.getElementById('complexitySection').style.display = 'block';
            }
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤–æ–æ–±—â–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            this.hideLoading();
            this.showError('–í –ø—Ä–æ–µ–∫—Ç–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–¥–∞—á–∏ –∏ –Ω–∞–∑–Ω–∞—á—å—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π.');
        }
    }

    renderWorkloadCharts() {
        if (this.workloadData.length === 0) {
            console.log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏');
            return;
        }

        try {
            console.log('üîÑ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏...');
            
            // –ì—Ä–∞—Ñ–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            const workloadCanvas = document.getElementById('workloadChart');
            console.log('workloadCanvas:', workloadCanvas);
            
            if (workloadCanvas && workloadCanvas.getContext) {
                console.log('‚úÖ Canvas workloadChart –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫...');
                const workloadCtx = workloadCanvas.getContext('2d');
                
                // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ Chart –¥–æ—Å—Ç—É–ø–µ–Ω
                if (typeof Chart === 'undefined') {
                    console.error('‚ùå Chart.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                    return;
                }
                
                new Chart(workloadCtx, {
                    type: 'bar',
                    data: {
                        labels: this.workloadData.map(user => user.username),
                        datasets: [{
                            label: '–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∫–∏ (%)',
                            data: this.workloadData.map(user => user.workload_percentage),
                            backgroundColor: this.workloadData.map(user => 
                                user.workload_percentage > 100 ? '#e74c3c' : 
                                user.workload_percentage > 80 ? '#f39c12' : '#2ecc71'
                            ),
                            borderColor: '#34495e',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: Math.max(100, ...this.workloadData.map(user => user.workload_percentage)) + 10,
                                title: {
                                    display: true,
                                    text: '–ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∫–∏'
                                }
                            }
                        }
                    }
                });
                console.log('‚úÖ –ì—Ä–∞—Ñ–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–∑–¥–∞–Ω');
            } else {
                console.error('‚ùå Canvas —ç–ª–µ–º–µ–Ω—Ç workloadChart –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }

            // –ì—Ä–∞—Ñ–∏–∫ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
            const complexityCanvas = document.getElementById('complexityChart');
            console.log('complexityCanvas:', complexityCanvas);
            
            if (complexityCanvas && complexityCanvas.getContext) {
                console.log('‚úÖ Canvas complexityChart –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫...');
                const complexityCtx = complexityCanvas.getContext('2d');
                
                new Chart(complexityCtx, {
                    type: 'bar',
                    data: {
                        labels: this.workloadData.map(user => user.username),
                        datasets: [{
                            label: '–û–±—â–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á',
                            data: this.workloadData.map(user => user.complexity_score),
                            backgroundColor: '#3498db',
                            borderColor: '#2980b9',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '–ë–∞–ª–ª—ã —Å–ª–æ–∂–Ω–æ—Å—Ç–∏'
                                }
                            }
                        }
                    }
                });
                console.log('‚úÖ –ì—Ä–∞—Ñ–∏–∫ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω');
            } else {
                console.error('‚ùå Canvas —ç–ª–µ–º–µ–Ω—Ç complexityChart –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤:', error);
        }
    }

    renderComplexityCharts() {
        if (this.complexityData.length === 0) {
            console.log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏');
            return;
        }

        try {
            console.log('üîÑ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏...');
            
            // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ –∑–∞–¥–∞—á–∞–º
            const tasksCanvas = document.getElementById('tasksComplexityChart');
            console.log('tasksCanvas:', tasksCanvas);
            
            if (tasksCanvas && tasksCanvas.getContext) {
                console.log('‚úÖ Canvas tasksComplexityChart –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫...');
                const tasksCtx = tasksCanvas.getContext('2d');
                
                new Chart(tasksCtx, {
                    type: 'pie',
                    data: {
                        labels: this.complexityData.map(task => task.title),
                        datasets: [{
                            data: this.complexityData.map(task => task.complexity),
                            backgroundColor: this.generateColors(this.complexityData.length)
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                console.log('‚úÖ –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω');
            }

            // –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º
            const priorityGroups = this.groupByPriority();
            const priorityCanvas = document.getElementById('priorityComplexityChart');
            console.log('priorityCanvas:', priorityCanvas);
            
            if (priorityCanvas && priorityCanvas.getContext) {
                console.log('‚úÖ Canvas priorityComplexityChart –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫...');
                const priorityCtx = priorityCanvas.getContext('2d');
                
                new Chart(priorityCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(priorityGroups).map(priority => this.getPriorityLabel(priority)),
                        datasets: [{
                            data: Object.values(priorityGroups).map(group => 
                                group.reduce((sum, task) => sum + task.complexity, 0)
                            ),
                            backgroundColor: ['#27ae60', '#f39c12', '#e74c3c', '#c0392b']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
                console.log('‚úÖ –ì—Ä–∞—Ñ–∏–∫ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º —Å–æ–∑–¥–∞–Ω');
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:', error);
        }
    }

    renderWorkloadDetails() {
        const detailsContainer = document.getElementById('workloadDetails');
        const summaryContainer = document.getElementById('workloadSummary');

        if (!detailsContainer || !summaryContainer) {
            console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            return;
        }

        if (this.workloadData.length === 0) {
            detailsContainer.innerHTML = '<p class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–≥—Ä—É–∑–∫–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>';
            summaryContainer.innerHTML = '<p class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
            return;
        }

        // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const totalWorkload = this.workloadData.reduce((sum, user) => sum + user.workload_percentage, 0);
        const avgWorkload = totalWorkload / this.workloadData.length;
        const overloadedUsers = this.workloadData.filter(user => user.workload_percentage > 100).length;

        summaryContainer.innerHTML = `
            <div class="stat-item">
                <span class="stat-value">${this.workloadData.length}</span>
                <span class="stat-label">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">${avgWorkload.toFixed(1)}%</span>
                <span class="stat-label">–°—Ä–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">${overloadedUsers}</span>
                <span class="stat-label">–ü–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–æ</span>
            </div>
        `;

        // –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
        detailsContainer.innerHTML = this.workloadData.map(user => `
            <div class="user-workload-card">
                <div class="user-header">
                    <h4>${this.escapeHtml(user.username)}</h4>
                    <span class="user-role">${user.role}</span>
                </div>
                <div class="workload-metrics">
                    <div class="metric">
                        <span class="metric-label">–ó–∞–≥—Ä—É–∑–∫–∞:</span>
                        <span class="metric-value ${user.workload_percentage > 100 ? 'overloaded' : ''}">
                            ${user.workload_percentage}%
                        </span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">–ó–∞–¥–∞—á–∏:</span>
                        <span class="metric-value">${user.task_count}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">–°–ª–æ–∂–Ω–æ—Å—Ç—å:</span>
                        <span class="metric-value">${user.complexity_score}</span>
                    </div>
                </div>
                ${user.tasks && user.tasks.length > 0 ? `
                <div class="user-tasks">
                    <strong>–ó–∞–¥–∞—á–∏:</strong>
                    ${user.tasks.map(task => `
                        <div class="task-item">
                            <span class="task-title">${this.escapeHtml(task.title)}</span>
                            <span class="task-duration">${task.duration}–¥</span>
                            <span class="task-priority priority-${task.priority}">${this.getPriorityLabel(task.priority)}</span>
                        </div>
                    `).join('')}
                </div>
                ` : '<p class="no-tasks">–ù–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á</p>'}
            </div>
        `).join('');
    }

    renderComplexityTable() {
        const tableBody = document.querySelector('#complexityTable tbody');
        const summaryContainer = document.getElementById('complexitySummary');

        if (!tableBody || !summaryContainer) {
            console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã —Ç–∞–±–ª–∏—Ü—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            return;
        }

        if (this.complexityData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–¥–∞—á–∞—Ö</td></tr>';
            summaryContainer.innerHTML = '<p class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
            return;
        }

        // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const totalComplexity = this.complexityData.reduce((sum, task) => sum + task.complexity, 0);
        const avgComplexity = totalComplexity / this.complexityData.length;

        summaryContainer.innerHTML = `
            <div class="stat-item">
                <span class="stat-value">${this.complexityData.length}</span>
                <span class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">${totalComplexity.toFixed(1)}</span>
                <span class="stat-label">–û–±—â–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">${avgComplexity.toFixed(1)}</span>
                <span class="stat-label">–°—Ä–µ–¥–Ω—è—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å</span>
            </div>
        `;

        // –¢–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á
        tableBody.innerHTML = this.complexityData.map(task => `
            <tr>
                <td>${this.escapeHtml(task.title)}</td>
                <td>${task.duration} –¥–Ω.</td>
                <td><span class="priority-badge priority-${task.priority}">${this.getPriorityLabel(task.priority)}</span></td>
                <td>${task.complexity}</td>
                <td>
                    <div class="percentage-bar">
                        <div class="percentage-fill" style="width: ${task.percentage || 0}%"></div>
                        <span class="percentage-text">${task.percentage || 0}%</span>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    groupByPriority() {
        const groups = {};
        this.complexityData.forEach(task => {
            if (!groups[task.priority]) {
                groups[task.priority] = [];
            }
            groups[task.priority].push(task);
        });
        return groups;
    }

    getPriorityLabel(priority) {
        const labels = {
            'low': 'üîµ –ù–∏–∑–∫–∏–π',
            'medium': 'üü° –°—Ä–µ–¥–Ω–∏–π', 
            'high': 'üü† –í—ã—Å–æ–∫–∏–π',
            'critical': 'üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π'
        };
        return labels[priority] || priority;
    }

    generateColors(count) {
        const colors = [];
        for (let i = 0; i < count; i++) {
            const hue = (i * 137.5) % 360;
            colors.push(`hsl(${hue}, 70%, 60%)`);
        }
        return colors;
    }

    escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    showLoading() {
        document.getElementById('loadingMessage').style.display = 'block';
        document.getElementById('workloadSection').style.display = 'none';
        document.getElementById('complexitySection').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'none';
    }

    hideLoading() {
        document.getElementById('loadingMessage').style.display = 'none';
    }

    showError(message = '') {
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('workloadSection').style.display = 'none';
        document.getElementById('complexitySection').style.display = 'none';
        
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        if (message && errorText) {
            errorText.textContent = message;
        }
        errorMessage.style.display = 'block';
    }

    hideError() {
        document.getElementById('errorMessage').style.display = 'none';
    }
}
</script>

<style>
.analytics-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.analytics-header {
    text-align: center;
    margin-bottom: 30px;
}

.analytics-section {
    margin-bottom: 40px;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.workload-stats, .complexity-stats {
    margin-bottom: 20px;
}

.stat-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
}

.stat-item {
    text-align: center;
    padding: 10px;
}

.stat-value {
    display: block;
    font-size: 24px;
    font-weight: bold;
    color: #2c3e50;
}

.stat-label {
    display: block;
    font-size: 14px;
    color: #7f8c8d;
}

.workload-charts, .complexity-charts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.chart-container {
    background: white;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.chart-wrapper {
    height: 300px;
    position: relative;
}

.details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
}

.user-workload-card {
    border: 1px solid #e1e8ed;
    border-radius: 6px;
    padding: 15px;
    background: white;
}

.user-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 10px;
}

.user-role {
    background: #3498db;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
}

.workload-metrics {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    margin-bottom: 10px;
}

.metric {
    text-align: center;
}

.metric-label {
    display: block;
    font-size: 12px;
    color: #7f8c8d;
}

.metric-value {
    display: block;
    font-weight: bold;
    font-size: 16px;
}

.metric-value.overloaded {
    color: #e74c3c;
}

.user-tasks {
    margin-top: 10px;
}

.task-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px solid #f1f1f1;
}

.task-title {
    flex: 1;
    font-size: 14px;
}

.task-duration, .task-priority {
    font-size: 12px;
    margin-left: 8px;
}

.priority-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    color: white;
}

.priority-low { background: #27ae60; }
.priority-medium { background: #f39c12; }
.priority-high { background: #e74c3c; }
.priority-critical { background: #c0392b; }

.percentage-bar {
    position: relative;
    height: 20px;
    background: #ecf0f1;
    border-radius: 10px;
    overflow: hidden;
}

.percentage-fill {
    height: 100%;
    background: #3498db;
    transition: width 0.3s ease;
}

.percentage-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 12px;
    font-weight: bold;
    color: #2c3e50;
}

.analytics-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.analytics-table th,
.analytics-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e1e8ed;
}

.analytics-table th {
    background: #f8f9fa;
    font-weight: 600;
}

.loading-message, .error-message {
    text-align: center;
    padding: 40px;
    background: white;
    border-radius: 8px;
    margin: 20px 0;
}

.error-message {
    background: #ffeaa7;
}

.no-data {
    text-align: center;
    color: #7f8c8d;
    font-style: italic;
    padding: 20px;
}
</style>
{% endblock %}