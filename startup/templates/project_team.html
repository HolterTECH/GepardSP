{% extends "project_base.html" %}

{% block content %}
<div class="team-container">
    <div class="team-header">
        <h1>üë• –ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–µ–∫—Ç–∞ "{{ project.name }}"</h1>
        <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –ø—Ä–æ–µ–∫—Ç–∞</p>
    </div>
    
    <div class="members-section">
        <h3 class="section-title">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–∞–Ω–¥—ã</h3>
        
        {% if members %}
            <div class="members-grid">
                {% for member in members %}
                <div class="member-card">
                    <div class="member-info">
                        <h4>{{ member.username }}</h4>
                        <p>{{ member.email }}</p>
                        <small>ID: {{ member.user_id }}</small>
                    </div>
                    <div class="member-actions">
                        <span class="member-role role-{{ member.role }}">{{ member.role }}</span>
                        {% if member.user_id != current_user.id %}
                        <button class="btn btn-danger btn-small" onclick="removeMember({{ member.user_id }})">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <h3>–í –ø—Ä–æ–µ–∫—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h3>
                <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å –ø–æ–º–æ—â—å—é —Ñ–æ—Ä–º—ã –Ω–∏–∂–µ</p>
            </div>
        {% endif %}
    </div>
    
    <div class="add-member-section">
        <h3>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –ø–æ ID</h3>
        <form id="addMemberForm" class="add-member-form">
            <div class="form-group">
                <label for="userIdInput">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <div class="search-container">
                    <input type="number" id="userIdInput" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."
                           min="1"
                           class="user-id-input">
                    <button type="button" class="btn btn-secondary" onclick="findUserById()">
                        <span>üîç</span>
                        –ù–∞–π—Ç–∏
                    </button>
                </div>
                <small>–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</small>
            </div>
            
            <div id="userResult" class="user-result" style="display: none;">
                <div class="user-found-card">
                    <div class="user-info">
                        <h4 id="foundUserName"></h4>
                        <p id="foundUserEmail"></p>
                        <small>ID: <span id="foundUserId"></span></small>
                    </div>
                    <button type="button" class="btn btn-success" onclick="selectUser()">
                        <span>‚úì</span>
                        –í—ã–±—Ä–∞—Ç—å
                    </button>
                </div>
            </div>
            
            <div id="selectedUser" class="selected-user" style="display: none;">
                <div class="selected-user-card">
                    <div class="selected-user-info">
                        <span class="selected-user-name" id="selectedUserName"></span>
                        <span class="selected-user-id">ID: <span id="selectedUserId"></span></span>
                    </div>
                    <button type="button" class="btn btn-danger btn-small" onclick="deselectUser()">
                        <span>√ó</span>
                    </button>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="roleSelect">–†–æ–ª—å:</label>
                        <select id="roleSelect">
                            <option value="member">–£—á–∞—Å—Ç–Ω–∏–∫</option>
                            <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                        </select>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" id="addUserBtn">
                    <span>‚ûï</span>
                    –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø—Ä–æ–µ–∫—Ç
                </button>
            </div>
            
            <div id="userNotFound" class="alert alert-error" style="display: none;">
                –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let foundUser = null;
    let selectedUser = null;

    // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID
    async function findUserById() {
        const userIdInput = document.getElementById('userIdInput');
        const userId = userIdInput.value.trim();
        
        if (!userId) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            return;
        }
        
        const searchBtn = document.querySelector('.search-container button');
        const originalText = searchBtn.innerHTML;
        
        try {
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<span>‚è≥</span> –ü–æ–∏—Å–∫...';
            
            const response = await fetch(`/api/user/${userId}`);
            const data = await response.json();
            
            if (data.success) {
                foundUser = data.user;
                displayFoundUser(foundUser);
                hideError();
            } else {
                showError('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                clearFoundUser();
            }
        } catch (error) {
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message);
            clearFoundUser();
        } finally {
            searchBtn.disabled = false;
            searchBtn.innerHTML = originalText;
        }
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function displayFoundUser(user) {
        document.getElementById('foundUserName').textContent = user.username;
        document.getElementById('foundUserEmail').textContent = user.email;
        document.getElementById('foundUserId').textContent = user.id;
        document.getElementById('userResult').style.display = 'block';
    }
    
    // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
    function clearFoundUser() {
        foundUser = null;
        document.getElementById('userResult').style.display = 'none';
    }
    
    // –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function selectUser() {
        if (!foundUser) return;
        
        selectedUser = foundUser;
        document.getElementById('selectedUserName').textContent = selectedUser.username;
        document.getElementById('selectedUserId').textContent = selectedUser.id;
        document.getElementById('selectedUser').style.display = 'block';
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
        clearFoundUser();
        document.getElementById('userIdInput').value = '';
    }
    
    // –û—Ç–º–µ–Ω–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function deselectUser() {
        selectedUser = null;
        document.getElementById('selectedUser').style.display = 'none';
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
    function showError(message) {
        const errorDiv = document.getElementById('userNotFound');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }
    
    // –°–∫—Ä—ã—Ç—å –æ—à–∏–±–∫—É
    function hideError() {
        document.getElementById('userNotFound').style.display = 'none';
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    document.getElementById('addMemberForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!selectedUser) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            return;
        }
        
        const roleSelect = document.getElementById('roleSelect');
        const addBtn = document.getElementById('addUserBtn');
        
        const userId = selectedUser.id;
        const role = roleSelect.value;
        
        addBtn.disabled = true;
        addBtn.innerHTML = '<span>‚è≥</span> –î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
        
        try {
            const response = await fetch(`/api/project/{{ project.id }}/team`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId,
                    role: role
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç');
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message);
        } finally {
            addBtn.disabled = false;
            addBtn.innerHTML = '<span>‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø—Ä–æ–µ–∫—Ç';
        }
    });
    
    // –£–¥–∞–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞
    async function removeMember(userId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/project/{{ project.id }}/team/${userId}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('–£—á–∞—Å—Ç–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞');
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞: ' + error.message);
        }
    }
    
    // –ü–æ–∏—Å–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter
    document.getElementById('userIdInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            findUserById();
        }
    });
</script>
{% endblock %}