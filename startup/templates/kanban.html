{% extends "project_base.html" %}

{% block title %}–ö–∞–Ω–±–∞–Ω - {{ project.name }}{% endblock %}

{% block content %}
<div class="content-header">
    <h1>–ö–∞–Ω–±–∞–Ω –¥–æ—Å–∫–∞: {{ project.name }}</h1>
</div>

<!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ -->
<!-- –í kanban.html, –≤ —Ñ–æ—Ä–º–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
<div class="create-task-form">
    <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É</h3>
    <form id="taskForm">
        <input type="text" id="taskTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" required>
        <textarea id="taskDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏"></textarea>
        
        <div class="form-row">
            <div class="field-group">
                <label for="taskPriority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
                <select id="taskPriority">
                    <option value="low">üîµ –ù–∏–∑–∫–∏–π</option>
                    <option value="medium" selected>üü° –°—Ä–µ–¥–Ω–∏–π</option>
                    <option value="high">üü† –í—ã—Å–æ–∫–∏–π</option>
                    <option value="critical">üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</option>
                </select>
            </div>
            
            <div class="field-group">
                <label for="taskDuration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–µ–π):</label>
                <input type="number" id="taskDuration" min="1" value="1">
            </div>
        </div>
        
        <div class="date-fields">
            <div class="field-group">
                <label for="taskStartDate">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
                <input type="date" id="taskStartDate">
            </div>
            
            <div class="field-group">
                <label for="taskEndDate">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                <input type="date" id="taskEndDate">
            </div>
        </div>
        
        <button type="submit">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
    </form>
</div>

<!-- –ö–∞–Ω–±–∞–Ω –¥–æ—Å–∫–∞ -->
<div class="kanban-board">
    <div class="kanban-column" data-status="planned">
        <h3>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</h3>
        <div class="tasks-list" id="planned-list">
            {% for task in tasks if task['status'] == 'planned' %}
                <!-- –í –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–¥–∞—á–∏ –¥–æ–±–∞–≤—å—Ç–µ –±–ª–æ–∫ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º -->
                <div class="task-card" draggable="true" data-task-id="{{ task['id'] }}">
                    <div class="task-header">
                        <h4>{{ task['title'] }}</h4>
                        <button class="edit-btn" onclick="openEditModal({{ task['id'] }})">‚úèÔ∏è</button>
                    </div>
                    <p>{{ task['description'] }}</p>
                    
                    <!-- –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ë–õ–û–ö -->
                    <div class="task-priority">
                        <span class="priority-{{ task['priority'] or 'medium' }}">
                            {% if task['priority'] == 'low' %}üîµ –ù–∏–∑–∫–∏–π
                            {% elif task['priority'] == 'high' %}üü† –í—ã—Å–æ–∫–∏–π
                            {% elif task['priority'] == 'critical' %}üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
                            {% else %}üü° –°—Ä–µ–¥–Ω–∏–π{% endif %}
                        </span>
                    </div>
                    
                    <div class="task-dates">
                        <div class="date-info"><strong>–ù–∞—á–∞–ª–æ:</strong> {{ task['start_date'] }}</div>
                        <div class="date-info"><strong>–û–∫–æ–Ω—á–∞–Ω–∏–µ:</strong> {{ task['end_date'] }}</div>
                        <div class="date-info"><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> {{ task['duration'] }} –¥–Ω.</div>
                    </div>
                    <div class="task-assignees">
                        {% if task.assignees %}
                            {% for assignee in task.assignees %}
                                <span class="assignee-badge">{{ assignee.username }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="kanban-column" data-status="in_progress">
        <h3>–í —Ä–∞–±–æ—Ç–µ</h3>
        <div class="tasks-list" id="in-progress-list">
            {% for task in tasks if task['status'] == 'in_progress' %}
            <div class="task-card" draggable="true" data-task-id="{{ task['id'] }}">
                <div class="task-header">
                    <h4>{{ task['title'] }}</h4>
                    <button class="edit-btn" onclick="openEditModal({{ task['id'] }})">‚úèÔ∏è</button>
                </div>
                <p>{{ task['description'] }}</p>
                <div class="task-dates">
                    <div class="date-info"><strong>–ù–∞—á–∞–ª–æ:</strong> {{ task['start_date'] }}</div>
                    <div class="date-info"><strong>–û–∫–æ–Ω—á–∞–Ω–∏–µ:</strong> {{ task['end_date'] }}</div>
                    <div class="date-info"><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> {{ task['duration'] }} –¥–Ω.</div>
                </div>
                <div class="task-assignees">
                    {% if task.assignees %}
                        {% for assignee in task.assignees %}
                            <span class="assignee-badge">{{ assignee.username }}</span>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="kanban-column" data-status="completed">
        <h3>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</h3>
        <div class="tasks-list" id="completed-list">
            {% for task in tasks if task['status'] == 'completed' %}
            <div class="task-card" draggable="true" data-task-id="{{ task['id'] }}">
                <div class="task-header">
                    <h4>{{ task['title'] }}</h4>
                    <button class="edit-btn" onclick="openEditModal({{ task['id'] }})">‚úèÔ∏è</button>
                </div>
                <p>{{ task['description'] }}</p>
                <div class="task-dates">
                    <div class="date-info"><strong>–ù–∞—á–∞–ª–æ:</strong> {{ task['start_date'] }}</div>
                    <div class="date-info"><strong>–û–∫–æ–Ω—á–∞–Ω–∏–µ:</strong> {{ task['end_date'] }}</div>
                    <div class="date-info"><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> {{ task['duration'] }} –¥–Ω.</div>
                </div>
                <div class="task-assignees">
                    {% if task.assignees %}
                        {% for assignee in task.assignees %}
                            <span class="assignee-badge">{{ assignee.username }}</span>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<!-- –í –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</h3>
        <form id="editTaskForm">
            <input type="hidden" id="editTaskId">
            
            <div class="form-group">
                <label for="editTaskTitle">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                <input type="text" id="editTaskTitle" required>
            </div>
            
            <div class="form-group">
                <label for="editTaskDescription">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea id="editTaskDescription"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="editTaskPriority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
                    <select id="editTaskPriority">
                        <option value="low">üîµ –ù–∏–∑–∫–∏–π</option>
                        <option value="medium">üü° –°—Ä–µ–¥–Ω–∏–π</option>
                        <option value="high">üü† –í—ã—Å–æ–∫–∏–π</option>
                        <option value="critical">üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editTaskStatus">–°—Ç–∞—Ç—É—Å:</label>
                    <select id="editTaskStatus">
                        <option value="planned">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</option>
                        <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                        <option value="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
                    </select>
                </div>
            </div>
            
            <div class="date-fields">
                <div class="field-group">
                    <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
                    <input type="date" id="editStartDate">
                </div>
                <div class="field-group">
                    <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                    <input type="date" id="editEndDate">
                </div>
                <div class="field-group">
                    <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–µ–π):</label>
                    <input type="number" id="editDuration" min="1">
                </div>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π -->
            <div class="assignees-section">
                <label>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏:</label>
                <div id="assigneesList">
                    <!-- –°–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
                </div>
                <div class="add-assignee">
                    <select id="assigneeSelect">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è...</option>
                    </select>
                    <button type="button" onclick="addAssignee()">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                <button type="button" id="deleteTaskBtn" class="btn-danger">–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    const PROJECT_ID = parseInt(window.location.pathname.split('/')[2]);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
        initDragAndDrop();
        initTaskForm();
        initEditForm();
        initDateCalculations();
        initEditDateCalculations();
        initDeleteButton();
    });

    // Drag and Drop —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
    function initDragAndDrop() {
        const taskCards = document.querySelectorAll('.task-card');
        const columns = document.querySelectorAll('.kanban-column');

        let draggedTask = null;

        taskCards.forEach(card => {
            card.addEventListener('dragstart', function(e) {
                draggedTask = this;
                this.classList.add('dragging');
                e.dataTransfer.setData('text/plain', this.dataset.taskId);
            });

            card.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                draggedTask = null;
            });

            card.addEventListener('dblclick', function() {
                openEditModal(this.dataset.taskId);
            });
        });

        columns.forEach(column => {
            column.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.backgroundColor = '#d0d0d0';
            });

            column.addEventListener('dragleave', function() {
                this.style.backgroundColor = '#e0e0e0';
            });

            column.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.backgroundColor = '#e0e0e0';
                
                if (draggedTask) {
                    const taskId = draggedTask.dataset.taskId;
                    const newStatus = this.dataset.status;
                    const tasksList = this.querySelector('.tasks-list');
                    
                    tasksList.appendChild(draggedTask);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                    updateTaskStatus(taskId, newStatus);
                }
            });
        });
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
    function initTaskForm() {
        const taskForm = document.getElementById('taskForm');
        
        taskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const startDate = document.getElementById('taskStartDate').value;
            const endDate = document.getElementById('taskEndDate').value;
            const duration = parseInt(document.getElementById('taskDuration').value);
            
            createTask(title, description, duration, startDate, endDate);
        });
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
    function initEditForm() {
        const modal = document.getElementById('editModal');
        const closeBtn = document.querySelector('.close');
        const editForm = document.getElementById('editTaskForm');
        
        closeBtn.onclick = function() {
            modal.style.display = 'none';
        }
        
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            saveTaskChanges();
        });
    }

    // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
    function initDeleteButton() {
        document.getElementById('deleteTaskBtn').addEventListener('click', function() {
            const taskId = document.getElementById('editTaskId').value;
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) {
                deleteTask(taskId);
            }
        });
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –¥–∞—Ç –¥–ª—è —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è
    function initDateCalculations() {
        const startDateInput = document.getElementById('taskStartDate');
        const endDateInput = document.getElementById('taskEndDate');
        const durationInput = document.getElementById('taskDuration');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const today = new Date().toISOString().split('T')[0];
        if (!startDateInput.value) {
            startDateInput.value = today;
        }
        updateEndDateFromStartAndDuration();
        
        // –°–ª—É—à–∞—Ç–µ–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        startDateInput.addEventListener('change', function() {
            updateEndDateFromStartAndDuration();
        });
        
        durationInput.addEventListener('change', function() {
            updateEndDateFromStartAndDuration();
        });
        
        endDateInput.addEventListener('change', function() {
            updateDurationFromStartAndEnd();
        });
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –¥–∞—Ç –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function initEditDateCalculations() {
        const startDateInput = document.getElementById('editStartDate');
        const endDateInput = document.getElementById('editEndDate');
        const durationInput = document.getElementById('editDuration');
        
        // –°–ª—É—à–∞—Ç–µ–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        startDateInput.addEventListener('change', function() {
            updateEditEndDateFromStartAndDuration();
        });
        
        durationInput.addEventListener('change', function() {
            updateEditEndDateFromStartAndDuration();
        });
        
        endDateInput.addEventListener('change', function() {
            updateEditDurationFromStartAndEnd();
        });
    }

    function updateEndDateFromStartAndDuration() {
        const startDate = document.getElementById('taskStartDate').value;
        const duration = parseInt(document.getElementById('taskDuration').value);
        
        if (startDate && duration) {
            const start = new Date(startDate);
            const endDate = new Date(start.getTime() + (duration - 1) * 24 * 60 * 60 * 1000);
            document.getElementById('taskEndDate').value = endDate.toISOString().split('T')[0];
        }
    }

    function updateDurationFromStartAndEnd() {
        const startDate = document.getElementById('taskStartDate').value;
        const endDate = document.getElementById('taskEndDate').value;
        
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const duration = Math.ceil((end - start) / (24 * 60 * 60 * 1000)) + 1;
            document.getElementById('taskDuration').value = duration;
        }
    }

    // –§—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function updateEditEndDateFromStartAndDuration() {
        const startDate = document.getElementById('editStartDate').value;
        const duration = parseInt(document.getElementById('editDuration').value);
        
        if (startDate && duration) {
            const start = new Date(startDate);
            const endDate = new Date(start.getTime() + (duration - 1) * 24 * 60 * 60 * 1000);
            document.getElementById('editEndDate').value = endDate.toISOString().split('T')[0];
        }
    }

    function updateEditDurationFromStartAndEnd() {
        const startDate = document.getElementById('editStartDate').value;
        const endDate = document.getElementById('editEndDate').value;
        
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const duration = Math.ceil((end - start) / (24 * 60 * 60 * 1000)) + 1;
            document.getElementById('editDuration').value = duration;
        }
    }

    // API —Ñ—É–Ω–∫—Ü–∏–∏
    async function createTask(title, description, duration, startDate, endDate) {
        try {
            const response = await fetch(`/api/project/${PROJECT_ID}/task`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title,
                    description,
                    duration,
                    start_date: startDate,
                    end_date: endDate
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + result.error);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
        }
    }

    async function updateTaskStatus(taskId, newStatus) {
        try {
            await fetch(`/api/task/${taskId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    status: newStatus,
                    position: 0
                })
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –∑–∞–¥–∞—á–∏
    async function loadTaskAssignees(taskId) {
        try {
            const response = await fetch(`/api/task/${taskId}/assignees`);
            const assignees = await response.json();
            
            const assigneesList = document.getElementById('assigneesList');
            assigneesList.innerHTML = '';
            
            assignees.forEach(assignee => {
                const assigneeElement = document.createElement('div');
                assigneeElement.className = 'assignee-item';
                assigneeElement.innerHTML = `
                    <span>${assignee.username}</span>
                    <button type="button" onclick="removeAssignee(${taskId}, ${assignee.id})">√ó</button>
                `;
                assigneesList.appendChild(assigneeElement);
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π:', error);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
    async function loadAvailableAssignees() {
        try {
            const response = await fetch(`/api/project/${PROJECT_ID}/available_assignees`);
            const assignees = await response.json();
            
            const select = document.getElementById('assigneeSelect');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è...</option>';
            
            assignees.forEach(assignee => {
                const option = document.createElement('option');
                option.value = assignee.id;
                option.textContent = `${assignee.username} (${assignee.email})`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π:', error);
        }
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
    async function addAssignee() {
        const select = document.getElementById('assigneeSelect');
        const userId = select.value;
        const taskId = document.getElementById('editTaskId').value;
        
        if (!userId) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è');
            return;
        }
        
        try {
            const response = await fetch(`/api/task/${taskId}/assignees`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ user_id: parseInt(userId) })
            });
            
            const result = await response.json();
            
            if (result.success) {
                loadTaskAssignees(taskId);
                select.value = '';
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è: ' + result.error);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è');
        }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
    async function removeAssignee(taskId, userId) {
        try {
            const response = await fetch(`/api/task/${taskId}/assignees/${userId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                loadTaskAssignees(taskId);
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è: ' + result.error);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è');
        }
    }

    async function openEditModal(taskId) {
        try {
            const response = await fetch(`/api/task/${taskId}`);
            const task = await response.json();
            
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTaskTitle').value = task.title;
            document.getElementById('editTaskDescription').value = task.description;
            document.getElementById('editStartDate').value = task.start_date;
            document.getElementById('editEndDate').value = task.end_date;
            document.getElementById('editDuration').value = task.duration;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
            await loadTaskAssignees(taskId);
            await loadAvailableAssignees();
            
            document.getElementById('editModal').style.display = 'block';
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á–∏');
        }
    }

    async function saveTaskChanges() {
        const taskId = document.getElementById('editTaskId').value;
        const title = document.getElementById('editTaskTitle').value;
        const description = document.getElementById('editTaskDescription').value;
        const startDate = document.getElementById('editStartDate').value;
        const endDate = document.getElementById('editEndDate').value;
        const duration = parseInt(document.getElementById('editDuration').value);
        
        try {
            // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
            const updateResponse = await fetch(`/api/task/${taskId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    description: description
                })
            });

            const updateResult = await updateResponse.json();
            
            if (!updateResult.success) {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + updateResult.error);
            }

            // –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—ã –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            const datesResponse = await fetch(`/api/task/${taskId}/dates`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    start_date: startDate,
                    end_date: endDate,
                    duration: duration
                })
            });

            const datesResult = await datesResponse.json();
            
            if (datesResult.success) {
                document.getElementById('editModal').style.display = 'none';
                location.reload();
            } else {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞—Ç: ' + datesResult.error);
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message);
        }
    }

    async function deleteTask(taskId) {
        try {
            const response = await fetch(`/api/task/${taskId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                document.getElementById('editModal').style.display = 'none';
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + result.error);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
        }
    }
</script>
{% endblock %}