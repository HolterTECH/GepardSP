{% extends "project_base.html" %}

{% block title %}–°–µ—Ç–µ–≤–æ–π –≥—Ä–∞—Ñ–∏–∫ - {{ project.name }}{% endblock %}

{% block extra_css %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
<style>
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .network-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    #network {
        width: 100%;
        height: 600px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .controls {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .task-info {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .task-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    .task-item {
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 4px;
        background: #f9f9f9;
    }
    .task-item h4 {
        margin: 0 0 10px 0;
        color: #2c3e50;
    }
    .task-dates {
        font-size: 12px;
        color: #666;
    }
    .btn {
        background-color: #3498db;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    .btn:hover {
        background-color: #2980b9;
    }
    .btn-secondary {
        background-color: #95a5a6;
    }
    .btn-secondary:hover {
        background-color: #7f8c8d;
    }
    .form-group {
        margin-bottom: 15px;
    }
    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    select, input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    .critical-path {
        background-color: #ffeaa7 !important;
        border: 2px solid #fdcb6e !important;
    }
    .status-planned { border-left: 4px solid #3498db; }
    .status-in_progress { border-left: 4px solid #f39c12; }
    .status-completed { border-left: 4px solid #27ae60; }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 500px;
        max-width: 90%;
    }
    .close {
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .date-fields {
        display: flex;
        gap: 15px;
        margin: 15px 0;
    }
    .field-group {
        flex: 1;
    }
    .field-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        font-size: 14px;
    }
    .field-group input,
    .field-group select,
    .field-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 14px;
    }
    small {
        color: #666;
        font-size: 12px;
        display: block;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <h1>–°–µ—Ç–µ–≤–æ–π –≥—Ä–∞—Ñ–∏–∫: {{ project.name }}</h1>
</div>

<!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
<div class="controls">
    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–º</h3>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <div class="form-group" style="flex: 1; min-width: 200px;">
            <label for="layoutSelect">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —É–∑–ª–æ–≤:</label>
            <select id="layoutSelect">
                <option value="directed">–ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–µ</option>
                <option value="hierarchical">–î—Ä–µ–≤–æ–≤–∏–¥–Ω–æ–µ</option>
                <option value="random">–°–ª—É—á–∞–π–Ω–æ–µ</option>
            </select>
        </div>
        <div class="form-group" style="flex: 1; min-width: 200px;">
            <label for="physicsSelect">–§–∏–∑–∏–∫–∞ –≥—Ä–∞—Ñ–∞:</label>
            <select id="physicsSelect">
                <option value="true">–í–∫–ª—é—á–µ–Ω–∞</option>
                <option value="false">–í—ã–∫–ª—é—á–µ–Ω–∞</option>
            </select>
        </div>
        <div class="form-group" style="flex: 1; min-width: 200px;">
            <button class="btn" onclick="calculateCriticalPath()">üìä –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å</button>
        </div>
        <div class="form-group" style="flex: 1; min-width: 200px;">
            <button class="btn" onclick="stabilizeNetwork()" style="background-color: #9b59b6;">üîÑ –°—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div class="form-group" style="flex: 1; min-width: 200px;">
            <button class="btn" onclick="openCreateLinkModal()" style="background-color: #2ecc71;">üîó –°–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å</button>
        </div>
        <div class="form-group" style="flex: 1; min-width: 200px;">
            <button class="btn" onclick="openCreateTaskModal()" style="background-color: #e67e22;">‚ûï –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</button>
        </div>
        <div class="form-group" style="flex: 1; min-width: 200px;">
            <button class="btn" onclick="openCreateMilestoneModal()" style="background-color: #FFD700;">‚≠ê –î–æ–±–∞–≤–∏—Ç—å –≤–µ—Ö—É</button>
        </div>
    </div>
</div>

<!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–µ–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ -->
<div class="network-container">
    <h3>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π</h3>
    <div id="network"></div>
</div>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–∞—Ö -->
<div class="task-info">
    <h3>–ó–∞–¥–∞—á–∏ –ø—Ä–æ–µ–∫—Ç–∞</h3>
    <div class="task-list">
        {% for task in tasks %}
        <div class="task-item status-{{ task['status'] }}" data-task-id="{{ task['id'] }}">
            <h4>{{ task['title'] }}</h4>
            <p>{{ task['description'] }}</p>
            <div class="task-dates">
                <div><strong>–°—Ç–∞—Ç—É—Å:</strong> 
                    {% if task['status'] == 'planned' %}–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ
                    {% elif task['status'] == 'in_progress' %}–í —Ä–∞–±–æ—Ç–µ
                    {% else %}–í—ã–ø–æ–ª–Ω–µ–Ω–æ{% endif %}
                </div>
                <div><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> {{ task['duration'] }} –¥–Ω.</div>
                <div><strong>–ù–∞—á–∞–ª–æ:</strong> {{ task['start_date'] }}</div>
                <div><strong>–û–∫–æ–Ω—á–∞–Ω–∏–µ:</strong> {{ task['end_date'] }}</div>
                {% if task['dependencies'] %}
                <div><strong>–ó–∞–≤–∏—Å–∏—Ç –æ—Ç:</strong> {{ task['dependencies'] }}</div>
                {% endif %}
            </div>
            <button class="btn" onclick="editDependencies({{ task['id'] }}, '{{ task['title'] }}')" 
                    style="margin-top: 10px; padding: 5px 10px; font-size: 12px;">
                ‚úèÔ∏è –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            </button>
        </div>
        {% endfor %}
    </div>
</div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π -->
    <div id="dependenciesModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDependenciesModal()">&times;</span>
            <h3>–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∑–∞–¥–∞—á–∏: <span id="modalTaskTitle"></span></h3>
            <form id="dependenciesForm">
                <input type="hidden" id="modalTaskId">
                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á–∏, –æ—Ç –∫–æ—Ç–æ—Ä—ã—Ö –∑–∞–≤–∏—Å–∏—Ç —Ç–µ–∫—É—â–∞—è:</label>
                    <div id="dependenciesList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                        <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω JavaScript -->
                    </div>
                </div>
                <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏</button>
            </form>
        </div>
    </div>

    <!-- –ù–û–í–û–ï –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–µ–π -->
    <div id="createLinkModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateLinkModal()">&times;</span>
            <h3>–°–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏</h3>
            <form id="createLinkForm">
                <div class="form-group">
                    <label for="fromTaskSelect">–ó–∞–¥–∞—á–∞-–ø—Ä–µ–¥—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫:</label>
                    <select id="fromTaskSelect" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="toTaskSelect">–ó–∞–¥–∞—á–∞-–ø—Ä–∏–µ–º–Ω–∏–∫:</label>
                    <select id="toTaskSelect" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="dependencyType">–¢–∏–ø —Å–≤—è–∑–∏:</label>
                    <select id="dependencyType" required>
                        <option value="FS">–û–∫–æ–Ω—á–∞–Ω–∏–µ-–ù–∞—á–∞–ª–æ (FS) - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</option>
                        <option value="SS">–ù–∞—á–∞–ª–æ-–ù–∞—á–∞–ª–æ (SS) - –∑–∞–¥–∞—á–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –≤–º–µ—Å—Ç–µ</option>
                        <option value="FF">–û–∫–æ–Ω—á–∞–Ω–∏–µ-–û–∫–æ–Ω—á–∞–Ω–∏–µ (FF) - –∑–∞–¥–∞—á–∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è –≤–º–µ—Å—Ç–µ</option>
                        <option value="SF">–ù–∞—á–∞–ª–æ-–û–∫–æ–Ω—á–∞–Ω–∏–µ (SF) - —Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="dependencyLag">–ó–∞–¥–µ—Ä–∂–∫–∞ (–¥–Ω–∏):</label>
                    <input type="number" id="dependencyLag" value="0" min="0">
                </div>
                
                <button type="submit" class="btn" style="background-color: #2ecc71;">–°–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å</button>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ—Ö -->
    <div id="createMilestoneModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateMilestoneModal()">&times;</span>
            <h3>–°–æ–∑–¥–∞–Ω–∏–µ –≤–µ—Ö–∏</h3>
            <form id="createMilestoneForm">
                <div class="form-group">
                    <label for="newMilestoneTitle">–ù–∞–∑–≤–∞–Ω–∏–µ –≤–µ—Ö–∏:</label>
                    <input type="text" id="newMilestoneTitle" placeholder="–í–∞–∂–Ω–∞—è –≤–µ—Ö–∞" required>
                </div>
                <div class="form-group">
                    <label for="newMilestoneDescription">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea id="newMilestoneDescription" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –≤–µ—Ö–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
                </div>
                <div class="form-group">
                    <label for="newMilestoneDate">–î–∞—Ç–∞ –≤–µ—Ö–∏:</label>
                    <input type="date" id="newMilestoneDate" required>
                </div>
                <div class="form-group">
                    <label for="newMilestoneColor">–¶–≤–µ—Ç:</label>
                    <input type="color" id="newMilestoneColor" value="#FFD700">
                </div>
                <button type="submit" class="btn" style="background-color: #FFD700;">–°–æ–∑–¥–∞—Ç—å –≤–µ—Ö—É</button>
                <button type="button" class="btn btn-secondary" onclick="closeCreateMilestoneModal()">–û—Ç–º–µ–Ω–∞</button>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–µ—Ö -->
    <div id="milestoneModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMilestoneModal()">&times;</span>
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ—Ö–∏</h3>
            <form id="milestoneForm">
                <input type="hidden" id="editMilestoneId">
                <div class="form-group">
                    <label for="editMilestoneTitle">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                    <input type="text" id="editMilestoneTitle" required>
                </div>
                <div class="form-group">
                    <label for="editMilestoneDescription">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea id="editMilestoneDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editMilestoneDate">–î–∞—Ç–∞:</label>
                    <input type="date" id="editMilestoneDate" required>
                </div>
                <div class="form-group">
                    <label for="editMilestoneColor">–¶–≤–µ—Ç:</label>
                    <input type="color" id="editMilestoneColor" value="#FFD700">
                </div>
                <button type="submit" class="btn" style="background-color: #FFD700;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Ö—É</button>
                <button type="button" class="btn btn-secondary" onclick="deleteMilestone()" style="margin-left: 10px;">–£–¥–∞–ª–∏—Ç—å –≤–µ—Ö—É</button>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
    <div id="createTaskModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateTaskModal()">&times;</span>
            <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É</h3>
            <form id="createTaskForm">
                <div class="form-group">
                    <label for="newTaskTitle">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:</label>
                    <input type="text" id="newTaskTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" required>
                </div>
                
                <div class="form-group">
                    <label for="newTaskDescription">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea id="newTaskDescription" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
                </div>
                
                <div class="date-fields">
                    <div class="field-group">
                        <label for="newTaskStartDate">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
                        <input type="date" id="newTaskStartDate">
                    </div>
                    
                    <div class="field-group">
                        <label for="newTaskDuration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–µ–π):</label>
                        <input type="number" id="newTaskDuration" min="1" value="1">
                    </div>
                    
                    <div class="field-group">
                        <label for="newTaskEndDate">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                        <input type="date" id="newTaskEndDate" readonly style="background-color: #f5f5f5;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="newTaskDependencies">–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                    <select id="newTaskDependencies" multiple style="height: 100px;">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏</option>
                    </select>
                    <small>–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–¥–∞—á</small>
                </div>
                
                <button type="submit" class="btn" style="background-color: #e67e22;">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
                <button type="button" class="btn btn-secondary" onclick="closeCreateTaskModal()">–û—Ç–º–µ–Ω–∞</button>
            </form>
        </div>
    </div>

    <script>
        const PROJECT_ID = {{ project.id }};
        let network = null;
        let allTasks = {{ tasks | tojson | safe }};

        // –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –ü–†–û–í–ï–†–ö–£ –î–ê–ù–ù–´–•
        console.log('–í—Å–µ –∑–∞–¥–∞—á–∏:', allTasks);
        console.log('–¢–∏–ø allTasks:', typeof allTasks);
        console.log('–î–ª–∏–Ω–∞ allTasks:', allTasks ? allTasks.length : 'null');

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        if (!allTasks) {
            console.error('allTasks is null –∏–ª–∏ undefined');
            allTasks = [];
        } else if (!Array.isArray(allTasks)) {
            console.error('allTasks –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º:', allTasks);
            allTasks = [];
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if (allTasks && allTasks.length > 0) {
            console.log('–ü–µ—Ä–≤–∞—è –∑–∞–¥–∞—á–∞:', allTasks[0]);
            console.log('–ö–ª—é—á–∏ –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏:', Object.keys(allTasks[0]));
        } else {
            console.warn('–ù–µ—Ç –∑–∞–¥–∞—á –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–µ–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
        async function initNetwork() {
            const container = document.getElementById('network');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (!container) {
                console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–µ—Ç–µ–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }

            try {
                const { nodes, edges } = await prepareNetworkData();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                if (nodes.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 50px; color: #666;">
                            <h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
                            <p>–°–æ–∑–¥–∞–π—Ç–µ –∑–∞–¥–∞—á–∏ –∏–ª–∏ –≤–µ—Ö–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–µ—Ç–µ–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞</p>
                        </div>
                    `;
                    return;
                }

                const data = {
                    nodes: new vis.DataSet(nodes),
                    edges: new vis.DataSet(edges)
                };

                // –£–ü–†–û–©–ï–ù–ù–´–ï –ò –ë–ï–ó–û–ü–ê–°–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò
                const options = {
                    layout: {
                        improvedLayout: true,
                        hierarchical: {
                            enabled: false
                        }
                    },
                    physics: {
                        enabled: false
                    },
                    nodes: {
                        shape: 'box',
                        margin: 10,
                        widthConstraint: {
                            maximum: 150
                        },
                        font: {
                            size: 12
                        }
                    },
                    edges: {
                        arrows: 'to',
                        smooth: false
                    },
                    interaction: {
                        dragNodes: true,
                        dragView: true,
                        zoomView: true
                    }
                };

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ vis –∑–∞–≥—Ä—É–∂–µ–Ω–∞
                if (typeof vis === 'undefined') {
                    throw new Error('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ vis.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                }

                network = new vis.Network(container, data, options);

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —É–∑–ª—É
                network.on("click", function(params) {
                    if (params.nodes.length > 0) {
                        const taskId = params.nodes[0];
                        showTaskDetails(taskId);
                    }
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ —Å–µ—Ç–∏
                network.on("initRedraw", function() {
                    console.log('–ì—Ä–∞—Ñ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞–Ω');
                });

                network.on("stabilizationIterationsDone", function() {
                    console.log('–°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                });

                console.log('–°–µ—Ç–µ–≤–æ–π –≥—Ä–∞—Ñ–∏–∫ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ç–µ–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #666;">
                        <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ç–µ–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞</h3>
                        <p>${error.message}</p>
                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
                        <button onclick="location.reload()" class="btn">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
                    </div>
                `;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function initControls() {
            document.getElementById('layoutSelect').addEventListener('change', function() {
                const layoutType = this.value;
                
                if (layoutType === 'hierarchical') {
                    network.setOptions({
                        layout: {
                            hierarchical: {
                                enabled: true,
                                direction: 'LR',
                                sortMethod: 'directed'
                            }
                        }
                    });
                } else if (layoutType === 'directed') {
                    network.setOptions({
                        layout: {
                            hierarchical: {
                                enabled: true,
                                direction: 'UD',
                                sortMethod: 'directed'
                            }
                        }
                    });
                } else if (layoutType === 'random') {
                    network.setOptions({
                        layout: {
                            hierarchical: {
                                enabled: false
                            }
                        }
                    });
                    
                    // –î–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –≤–∫–ª—é—á–∞–µ–º —Ñ–∏–∑–∏–∫—É
                    network.setOptions({
                        physics: {
                            enabled: true,
                            stabilization: {
                                enabled: true,
                                iterations: 100
                            }
                        }
                    });
                    
                    setTimeout(() => {
                        network.setOptions({
                            physics: false // –°–Ω–æ–≤–∞ –æ—Ç–∫–ª—é—á–∞–µ–º —Ñ–∏–∑–∏–∫—É –ø–æ—Å–ª–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
                        });
                    }, 1000);
                }
            });

            document.getElementById('physicsSelect').addEventListener('change', function() {
                const physicsEnabled = this.value === 'true';
                
                network.setOptions({
                    physics: {
                        enabled: physicsEnabled,
                        stabilization: physicsEnabled ? { enabled: true, iterations: 100 } : undefined
                    }
                });
                
                if (physicsEnabled) {
                    setTimeout(() => {
                        network.stabilize(100);
                    }, 100);
                }
            });

            document.getElementById('dependenciesForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveDependencies();
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏
        function showTaskDetails(taskId) {
            const task = allTasks.find(t => t.id == taskId);
            if (task) {
                alert(`–ó–∞–¥–∞—á–∞: ${task.title}\n` +
                      `–û–ø–∏—Å–∞–Ω–∏–µ: ${task.description}\n` +
                      `–°—Ç–∞—Ç—É—Å: ${task.status}\n` +
                      `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${task.duration} –¥–Ω–µ–π\n` +
                      `–î–∞—Ç—ã: ${task.start_date} - ${task.end_date}\n` +
                      `–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: ${task.dependencies || '–Ω–µ—Ç'}`);
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        function editDependencies(taskId, taskTitle) {
            document.getElementById('modalTaskId').value = taskId;
            document.getElementById('modalTaskTitle').textContent = taskTitle;
            
            const dependenciesList = document.getElementById('dependenciesList');
            dependenciesList.innerHTML = '';

            // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É
            const currentTask = allTasks.find(t => t.id == taskId);
            const currentDependencies = currentTask.dependencies ? 
                currentTask.dependencies.split(',').map(dep => dep.trim()) : [];

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞—á (–∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–π)
            allTasks.forEach(task => {
                if (task.id != taskId) {
                    const checkbox = document.createElement('div');
                    checkbox.innerHTML = `
                        <label style="display: block; margin: 5px 0;">
                            <input type="checkbox" value="${task.id}" 
                                ${currentDependencies.includes(task.id.toString()) ? 'checked' : ''}>
                            ${task.title} (ID: ${task.id})
                        </label>
                    `;
                    dependenciesList.appendChild(checkbox);
                }
            });

            document.getElementById('dependenciesModal').style.display = 'block';
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        function closeDependenciesModal() {
            document.getElementById('dependenciesModal').style.display = 'none';
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        async function saveDependencies() {
            const taskId = document.getElementById('modalTaskId').value;
            const checkboxes = document.querySelectorAll('#dependenciesList input[type="checkbox"]:checked');
            const dependencies = Array.from(checkboxes).map(cb => cb.value);

            try {
                const response = await fetch(`/api/task/${taskId}/dependencies`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        dependencies: dependencies
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
                    closeDependenciesModal();
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π');
            }
        }

        // –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞
        function stabilizeNetwork() {
            // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ –±–µ–∑ —Ñ–∏–∑–∏–∫–∏
            if (network) {
                network.redraw();
                alert('–ì—Ä–∞—Ñ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞–Ω!');
            }
        }

        // –†–∞—Å—á–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—É—Ç–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        function calculateCriticalPath() {
            // –ü—Ä–æ—Å—Ç–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è - –≤—ã–¥–µ–ª—è–µ–º –∑–∞–¥–∞—á–∏ —Å –Ω–∞–∏–±–æ–ª—å—à–µ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
            const maxDuration = Math.max(...allTasks.map(task => task.duration));
            
            allTasks.forEach(task => {
                if (task.duration === maxDuration) {
                    // –ù–∞—Ö–æ–¥–∏–º —É–∑–µ–ª –≤ –≥—Ä–∞—Ñ–µ –∏ –≤—ã–¥–µ–ª—è–µ–º –µ–≥–æ
                    const node = network.body.data.nodes.get(task.id);
                    if (node) {
                        network.body.data.nodes.update({
                            id: task.id,
                            color: '#e74c3c', // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á
                            borderWidth: 3,
                            borderColor: '#c0392b'
                        });
                    }
                }
            });
            
            alert(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å –≤—ã–¥–µ–ª–µ–Ω –∫—Ä–∞—Å–Ω—ã–º —Ü–≤–µ—Ç–æ–º\n–°–∞–º–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞: ${maxDuration} –¥–Ω–µ–π`);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('dependenciesModal');
            if (event.target == modal) {
                closeDependenciesModal();
            }
        }

        // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ –±–ª–æ–∫ window.onclick
        window.onclick = function(event) {
            const dependenciesModal = document.getElementById('dependenciesModal');
            const createLinkModal = document.getElementById('createLinkModal');
            const createTaskModal = document.getElementById('createTaskModal');
            const createMilestoneModal = document.getElementById('createMilestoneModal');
            const milestoneModal = document.getElementById('milestoneModal');
            
            if (event.target == dependenciesModal) {
                closeDependenciesModal();
            }
            if (event.target == createLinkModal) {
                closeCreateLinkModal();
            }
            if (event.target == createTaskModal) {
                closeCreateTaskModal();
            }
            if (event.target == createMilestoneModal) {
                closeCreateMilestoneModal();
            }
            if (event.target == milestoneModal) {
                closeMilestoneModal();
            }
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–µ—Ö
        let allMilestones = [];

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–µ—Ö –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        async function loadMilestones() {
            try {
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –≤–µ—Ö...');
                const response = await fetch(`/api/project/${PROJECT_ID}/milestones`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const milestones = await response.json();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ –º–∞—Å—Å–∏–≤
                if (!Array.isArray(milestones)) {
                    console.warn('–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –≤–µ—Ö–∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º:', milestones);
                    allMilestones = [];
                } else {
                    allMilestones = milestones;
                }
                
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –≤–µ—Ö–∏:', allMilestones);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–µ—Ö:', error);
                allMilestones = [];
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –≤–µ—Ö–∏
        async function createMilestone(event) {
            if (event) event.preventDefault();
            
            const title = document.getElementById('newMilestoneTitle').value;
            const description = document.getElementById('newMilestoneDescription').value;
            const date = document.getElementById('newMilestoneDate').value;
            const color = document.getElementById('newMilestoneColor').value;
            
            if (!title || !date) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –¥–∞—Ç—É –≤–µ—Ö–∏');
                return;
            }
            
            try {
                const response = await fetch(`/api/project/${PROJECT_ID}/milestone`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        date,
                        color
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('–í–µ—Ö–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
                    closeCreateMilestoneModal();
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤–µ—Ö–∏: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤–µ—Ö–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤–µ—Ö–∏');
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é prepareNetworkData –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–≤—è–∑–µ–π
        async function prepareNetworkData() {
            const nodes = [];
            const edges = [];

            console.log('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö: allTasks=', allTasks, 'allMilestones=', allMilestones);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –∑–∞–¥–∞—á–∏ –∏ —ç—Ç–æ –º–∞—Å—Å–∏–≤
            if (!allTasks || !Array.isArray(allTasks)) {
                console.warn('–ù–µ—Ç –∑–∞–¥–∞—á –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–µ—Ç–µ–≤–æ–º –≥—Ä–∞—Ñ–∏–∫–µ');
                allTasks = [];
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã
            let allDependencies = [];
            try {
                const response = await fetch(`/api/project/${PROJECT_ID}/dependencies`);
                if (response.ok) {
                    allDependencies = await response.json();
                    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:', allDependencies);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:', error);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏ (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
            allTasks.forEach(task => {
                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–¥–∞—á–∞ –∏–º–µ–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è
                    if (!task || task.id === undefined || task.id === null || !task.title) {
                        console.warn('–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∑–∞–¥–∞—á–∞:', task);
                        return;
                    }

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —É–∑–ª–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
                    let color = '#3498db'; // planned - —Å–∏–Ω–∏–π
                    if (task.status === 'in_progress') color = '#f39c12'; // in_progress - –æ—Ä–∞–Ω–∂–µ–≤—ã–π
                    if (task.status === 'completed') color = '#27ae60'; // completed - –∑–µ–ª–µ–Ω—ã–π

                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö –≤ label
                    let label = `${task.title}\n${task.duration || 0}–¥`;
                    
                    // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–∏ —Å—Ç–∞—Ä—ã—Ö F-S –∏ –Ω–æ–≤—ã—Ö)
                    const fsDepsCount = task.dependencies ? 
                        task.dependencies.split(',').filter(dep => dep.trim() !== '').length : 0;
                    const newDepsCount = allDependencies.filter(dep => dep.task_id == task.id).length;
                    const totalDepsCount = fsDepsCount + newDepsCount;
                    
                    if (totalDepsCount > 0) {
                        label += `\n‚Üì ${totalDepsCount} –∑–∞–≤.`;
                    }

                    // –°–æ–∑–¥–∞–µ–º —É–∑–µ–ª
                    nodes.push({
                        id: task.id,
                        label: label,
                        color: color,
                        font: { color: 'white' },
                        shape: 'box',
                        margin: 8,
                        title: `–ó–∞–¥–∞—á–∞: ${task.title}\n–°—Ç–∞—Ç—É—Å: ${task.status}\n–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${task.duration}–¥`
                    });
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–¥–∞—á–∏:', task, error);
                }
            });

            // –°–æ–∑–¥–∞–µ–º —Å–≤—è–∑–∏ –¥–ª—è –°–¢–ê–†–´–• F-S –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–∏–∑ –ø–æ–ª—è dependencies)
            allTasks.forEach(task => {
                if (task.dependencies && task.dependencies.trim() !== '') {
                    const dependencies = task.dependencies.split(',').map(dep => dep.trim()).filter(dep => dep !== '');
                    dependencies.forEach(depId => {
                        const depIdNum = parseInt(depId);
                        if (!isNaN(depIdNum)) {
                            const dependencyExists = allTasks.some(t => t.id == depIdNum);
                            if (dependencyExists) {
                                edges.push({
                                    from: depIdNum,
                                    to: task.id,
                                    arrows: 'to',
                                    color: '#2E7D32', // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è FS
                                    dashes: false,
                                    width: 2,
                                    label: 'FS',
                                    title: 'F-S —Å–≤—è–∑—å (—Å—Ç–∞—Ä–∞—è)'
                                });
                            }
                        }
                    });
                }
            });

            // –°–æ–∑–¥–∞–µ–º —Å–≤—è–∑–∏ –¥–ª—è –ù–û–í–´–• –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤—Å–µ—Ö —Ç–∏–ø–æ–≤
            allDependencies.forEach(dep => {
                const fromExists = allTasks.some(t => t.id == dep.predecessor_id);
                const toExists = allTasks.some(t => t.id == dep.task_id);
                
                if (fromExists && toExists) {
                    const edgeConfig = {
                        from: dep.predecessor_id,
                        to: dep.task_id,
                        arrows: 'to',
                        width: 2,
                        label: dep.dependency_type + (dep.lag ? `+${dep.lag}–¥` : ''),
                        title: `${getDependencyTypeText(dep.dependency_type)}${dep.lag ? ` —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π ${dep.lag}–¥` : ''}`
                    };

                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–≤—è–∑–∏
                    switch(dep.dependency_type) {
                        case 'FS':
                            edgeConfig.color = '#2E7D32'; // –ó–µ–ª–µ–Ω—ã–π
                            edgeConfig.dashes = false;
                            break;
                        case 'SS':
                            edgeConfig.color = '#1976D2'; // –°–∏–Ω–∏–π
                            edgeConfig.dashes = [5, 5];
                            break;
                        case 'FF':
                            edgeConfig.color = '#7B1FA2'; // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
                            edgeConfig.dashes = [10, 5];
                            break;
                        case 'SF':
                            edgeConfig.color = '#D32F2F'; // –ö—Ä–∞—Å–Ω—ã–π
                            edgeConfig.dashes = [5, 10];
                            break;
                        default:
                            edgeConfig.color = '#848484';
                            edgeConfig.dashes = false;
                    }

                    edges.push(edgeConfig);
                }
            });

            // –î–û–ë–ê–í–õ–Ø–ï–ú –í–ï–•–ò –ö–ê–ö –û–°–û–ë–´–ï –£–ó–õ–´
            if (allMilestones && Array.isArray(allMilestones)) {
                allMilestones.forEach(milestone => {
                    try {
                        const milestoneId = 'milestone_' + milestone.id;
                        
                        if (!nodes.some(node => node.id === milestoneId)) {
                            nodes.push({
                                id: milestoneId,
                                label: `‚≠ê ${milestone.title}\n${milestone.date}`,
                                color: milestone.color || '#FFD700',
                                font: { color: '#000000' },
                                shape: 'diamond',
                                size: 25,
                                borderWidth: 2,
                                borderColor: '#000000',
                                title: milestone.description || `–í–µ—Ö–∞: ${milestone.title}`
                            });
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–µ—Ö–∏:', milestone, error);
                    }
                });
            }

            console.log(`–°–æ–∑–¥–∞–Ω–æ —É–∑–ª–æ–≤: ${nodes.length}, —Å–≤—è–∑–µ–π: ${edges.length}`);
            return { nodes, edges };
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–∏–ø–∞ —Å–≤—è–∑–∏
        function getDependencyTypeText(type) {
            const types = {
                'FS': '–û–∫–æ–Ω—á–∞–Ω–∏–µ-–ù–∞—á–∞–ª–æ',
                'SS': '–ù–∞—á–∞–ª–æ-–ù–∞—á–∞–ª–æ',
                'FF': '–û–∫–æ–Ω—á–∞–Ω–∏–µ-–û–∫–æ–Ω—á–∞–Ω–∏–µ', 
                'SF': '–ù–∞—á–∞–ª–æ-–û–∫–æ–Ω—á–∞–Ω–∏–µ'
            };
            return types[type] || type;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–∏ –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏
        async function createTaskLink(fromTaskId, toTaskId, linkType = 'FS') {
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–ª–µ–≤—É—é –∑–∞–¥–∞—á—É
                const toTask = allTasks.find(t => t.id == toTaskId);
                if (!toTask) {
                    alert('–¶–µ–ª–µ–≤–∞—è –∑–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    return;
                }

                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
                const currentDependencies = toTask.dependencies ? 
                    toTask.dependencies.split(',').map(dep => dep.trim()).filter(dep => dep !== '') : [];

                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, –µ—Å–ª–∏ –µ–µ –µ—â–µ –Ω–µ—Ç
                if (!currentDependencies.includes(fromTaskId.toString())) {
                    currentDependencies.push(fromTaskId.toString());
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
                const response = await fetch(`/api/task/${toTaskId}/dependencies`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        dependencies: currentDependencies,
                        link_type: linkType // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø —Å–≤—è–∑–∏
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(`F-S —Å–≤—è–∑—å —Å–æ–∑–¥–∞–Ω–∞! –ó–∞–¥–∞—á–∞ "${getTaskTitle(fromTaskId)}" ‚Üí "${toTask.title}"`);
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–≤—è–∑–∏: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–≤—è–∑–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–≤—è–∑–∏');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ –ø–æ ID
        function getTaskTitle(taskId) {
            const task = allTasks.find(t => t.id == taskId);
            return task ? task.title : `–ó–∞–¥–∞—á–∞ ${taskId}`;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–µ–π –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function addCreateLinkButton() {
            const controls = document.querySelector('.controls');
            if (!controls) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç controls –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            const createLinkBtn = document.createElement('button');
            createLinkBtn.className = 'btn';
            createLinkBtn.style.backgroundColor = '#2ecc71';
            createLinkBtn.innerHTML = 'üîó –°–æ–∑–¥–∞—Ç—å F-S —Å–≤—è–∑—å';
            createLinkBtn.onclick = openCreateLinkModal;
            
            controls.appendChild(createLinkBtn);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('–ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...');
                
                // 1. –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ
                await loadMilestones();
                console.log('–í–µ—Ö–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', allMilestones);
                
                // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
                initCreateTaskForm();

                // 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ—Ö–∏
                document.getElementById('createMilestoneForm').addEventListener('submit', createMilestone);
                
                // 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã
                initControls();
                
                // 5. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–µ–π
                document.getElementById('createLinkForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    createNewDependency();
                });
                
                // 6. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Ç–µ–≤–æ–π –≥—Ä–∞—Ñ–∏–∫ –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
                await initNetwork();
                
                // 7. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –≤–µ—Ö
                const today = new Date().toISOString().split('T')[0];
                
                console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            }
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ—Ö
        function openCreateMilestoneModal() {
            const modal = document.getElementById('createMilestoneModal');
            const today = new Date().toISOString().split('T')[0];
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            document.getElementById('newMilestoneDate').value = today;
            document.getElementById('newMilestoneTitle').value = '';
            document.getElementById('newMilestoneDescription').value = '';
            document.getElementById('newMilestoneColor').value = '#FFD700';
            
            modal.style.display = 'block';
        }

        function closeCreateMilestoneModal() {
            document.getElementById('createMilestoneModal').style.display = 'none';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        async function deleteDependency(dependencyId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–≤—è–∑—å?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/dependency/${dependencyId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('–°–≤—è–∑—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!');
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏');
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤–µ—Ö
        function openMilestoneModal(milestoneId) {
            const milestone = allMilestones.find(m => m.id == milestoneId);
            if (milestone) {
                document.getElementById('editMilestoneId').value = milestone.id;
                document.getElementById('editMilestoneTitle').value = milestone.title;
                document.getElementById('editMilestoneDescription').value = milestone.description || '';
                document.getElementById('editMilestoneDate').value = milestone.date;
                document.getElementById('editMilestoneColor').value = milestone.color || '#FFD700';
                
                document.getElementById('milestoneModal').style.display = 'block';
            }
        }

        function closeMilestoneModal() {
            document.getElementById('milestoneModal').style.display = 'none';
        }

        async function saveMilestone() {
            const milestoneId = document.getElementById('editMilestoneId').value;
            const title = document.getElementById('editMilestoneTitle').value;
            const description = document.getElementById('editMilestoneDescription').value;
            const date = document.getElementById('editMilestoneDate').value;
            const color = document.getElementById('editMilestoneColor').value;
            
            if (!title || !date) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –¥–∞—Ç—É –≤–µ—Ö–∏');
                return;
            }
            
            try {
                const response = await fetch(`/api/milestone/${milestoneId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        date,
                        color
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('–í–µ—Ö–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                    closeMilestoneModal();
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–µ—Ö–∏: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–µ—Ö–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–µ—Ö–∏');
            }
        }

        async function deleteMilestone() {
            const milestoneId = document.getElementById('editMilestoneId').value;
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –≤–µ—Ö—É?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/milestone/${milestoneId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('–í–µ—Ö–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!');
                    closeMilestoneModal();
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–µ—Ö–∏: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–µ—Ö–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–µ—Ö–∏');
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —É–∑–ª—É –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤–µ—Ö
        function showTaskDetails(nodeId) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É–∑–µ–ª –≤–µ—Ö–æ–π
            if (nodeId.toString().startsWith('milestone_')) {
                const milestoneId = nodeId.toString().replace('milestone_', '');
                const milestone = allMilestones.find(m => m.id == milestoneId);
                if (milestone) {
                    openMilestoneModal(milestoneId);
                    return;
                }
            }
            
            // –û–±—ã—á–Ω–∞—è –∑–∞–¥–∞—á–∞ - –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            const task = allTasks.find(t => t.id == nodeId);
            if (task) {
                alert(`–ó–∞–¥–∞—á–∞: ${task.title}\n` +
                    `–°—Ç–∞—Ç—É—Å: ${task.status}\n` +
                    `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${task.duration} –¥–Ω–µ–π\n` +
                    `–î–∞—Ç—ã: ${task.start_date} - ${task.end_date}\n` +
                    `–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: ${task.dependencies || '–Ω–µ—Ç'}`);
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –≤–µ—Ö
        document.getElementById('milestoneForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveMilestone();
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–µ–π
        function openCreateLinkModal() {
            const modal = document.getElementById('createLinkModal');
            const fromSelect = document.getElementById('fromTaskSelect');
            const toSelect = document.getElementById('toTaskSelect');
            
            // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–∫–∏ –∑–∞–¥–∞—á
            fromSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É</option>';
            toSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É</option>';
            
            allTasks.forEach(task => {
                const option1 = document.createElement('option');
                option1.value = task.id;
                option1.textContent = task.title;
                fromSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = task.id;
                option2.textContent = task.title;
                toSelect.appendChild(option2);
            });
            
            modal.style.display = 'block';
        }

        function closeCreateLinkModal() {
            document.getElementById('createLinkModal').style.display = 'none';
            document.getElementById('createLinkForm').reset();
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–∏ —á–µ—Ä–µ–∑ –Ω–æ–≤–æ–µ API
        async function createNewDependency() {
            const fromTaskId = document.getElementById('fromTaskSelect').value;
            const toTaskId = document.getElementById('toTaskSelect').value;
            const dependencyType = document.getElementById('dependencyType').value;
            const lag = parseInt(document.getElementById('dependencyLag').value) || 0;
            
            if (!fromTaskId || !toTaskId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–µ –∑–∞–¥–∞—á–∏');
                return;
            }
            
            if (fromTaskId === toTaskId) {
                alert('–ó–∞–¥–∞—á–∞ –Ω–µ –º–æ–∂–µ—Ç –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç —Å–∞–º–æ–π —Å–µ–±—è');
                return;
            }
            
            try {
                const response = await fetch(`/api/task/${toTaskId}/dependency`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        predecessor_id: fromTaskId,
                        dependency_type: dependencyType,
                        lag: lag
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('–°–≤—è–∑—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
                    closeCreateLinkModal();
                    location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∞
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–≤—è–∑–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–≤—è–∑–∏');
            }
        }

        // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('createLinkModal');
            if (event.target == modal) {
                closeCreateLinkModal();
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
        function openCreateTaskModal() {
            const modal = document.getElementById('createTaskModal');
            const today = new Date().toISOString().split('T')[0];
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            document.getElementById('newTaskStartDate').value = today;
            document.getElementById('newTaskDuration').value = 1;
            document.getElementById('newTaskTitle').value = '';
            document.getElementById('newTaskDescription').value = '';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è
            updateNewTaskEndDate();
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            populateDependenciesSelect();
            
            modal.style.display = 'block';
        }

        function closeCreateTaskModal() {
            document.getElementById('createTaskModal').style.display = 'none';
        }

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        function populateDependenciesSelect() {
            const select = document.getElementById('newTaskDependencies');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏</option>';
            
            allTasks.forEach(task => {
                const option = document.createElement('option');
                option.value = task.id;
                option.textContent = `${task.title} (ID: ${task.id})`;
                select.appendChild(option);
            });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è
        function updateNewTaskEndDate() {
            const startDate = document.getElementById('newTaskStartDate').value;
            const duration = parseInt(document.getElementById('newTaskDuration').value);
            
            if (startDate && duration) {
                const start = new Date(startDate);
                const endDate = new Date(start.getTime() + (duration - 1) * 24 * 60 * 60 * 1000);
                document.getElementById('newTaskEndDate').value = endDate.toISOString().split('T')[0];
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
        async function createNewTask(event) {
            event.preventDefault();
            
            const title = document.getElementById('newTaskTitle').value;
            const description = document.getElementById('newTaskDescription').value;
            const startDate = document.getElementById('newTaskStartDate').value;
            const duration = parseInt(document.getElementById('newTaskDuration').value);
            const dependenciesSelect = document.getElementById('newTaskDependencies');
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            const selectedDependencies = Array.from(dependenciesSelect.selectedOptions)
                .map(option => option.value)
                .filter(value => value !== '');
            
            if (!title) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
                return;
            }
            
            try {
                const response = await fetch(`/api/project/${PROJECT_ID}/task`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        duration,
                        start_date: startDate
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const taskId = result.task_id;
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö
                    if (selectedDependencies.length > 0) {
                        await saveTaskDependencies(taskId, selectedDependencies);
                    }
                    
                    alert('–ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
                    closeCreateTaskModal();
                    location.reload(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∑–∞–¥–∞—á–∏
        async function saveTaskDependencies(taskId, dependencies) {
            try {
                const response = await fetch(`/api/task/${taskId}/dependencies`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        dependencies: dependencies
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:', result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:', error);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
        function initCreateTaskForm() {
            const createTaskForm = document.getElementById('createTaskForm');
            const startDateInput = document.getElementById('newTaskStartDate');
            const durationInput = document.getElementById('newTaskDuration');
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
            createTaskForm.addEventListener('submit', createNewTask);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            startDateInput.addEventListener('change', updateNewTaskEndDate);
            durationInput.addEventListener('change', updateNewTaskEndDate);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const today = new Date().toISOString().split('T')[0];
            startDateInput.value = today;
            updateNewTaskEndDate();
        }

    </script>
{% endblock %}