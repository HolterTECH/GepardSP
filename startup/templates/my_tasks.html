{% extends "main_base.html" %}

{% block title %}–ú–æ–∏ –∑–∞–¥–∞—á–∏{% endblock %}

{% block content %}
<div class="content-header">
    <h1>–ú–æ–∏ –∑–∞–¥–∞—á–∏</h1>
</div>

<!-- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–¥–∞—á -->
<!-- –§–∏–ª—å—Ç—Ä —Ç–∏–ø–∞ –∑–∞–¥–∞—á -->
<div class="tasks-filter">
    <label for="taskTypeFilter">–¢–∏–ø –∑–∞–¥–∞—á:</label>
    <select id="taskTypeFilter" class="task-type-select">
        <option value="all">üìä –í—Å–µ –∑–∞–¥–∞—á–∏</option>
        <option value="personal">üìù –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏</option>
        <option value="assigned">üë• –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –º–Ω–µ</option>
    </select>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value" id="total-tasks">0</div>
        <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="planned-tasks">0</div>
        <div class="stat-label">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="progress-tasks">0</div>
        <div class="stat-label">–í —Ä–∞–±–æ—Ç–µ</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="completed-tasks">0</div>
        <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
    </div>
</div>

<!-- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∞ -->
<div class="view-toggle">
    <button class="view-toggle-btn active" data-view="kanban">üìã –ö–∞–Ω–±–∞–Ω –¥–æ—Å–∫–∞</button>
    <button class="view-toggle-btn" data-view="list">üìù –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á</button>
</div>

<!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –∑–∞–¥–∞—á–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á) -->
<div id="personal-task-form" class="create-task-form">
    <h3>‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –∑–∞–¥–∞—á—É</h3>
    <form id="taskForm">
        <div class="form-group">
            <input type="text" id="taskTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" required>
        </div>
        <div class="form-group">
            <textarea id="taskDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="2"></textarea>
        </div>
        
        <div class="date-fields">
            <div class="field-group">
                <label for="taskStartDate">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
                <input type="date" id="taskStartDate">
            </div>
            
            <div class="field-group">
                <label for="taskDuration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–µ–π):</label>
                <input type="number" id="taskDuration" min="1" value="1">
            </div>
            
            <div class="field-group">
                <label for="taskEndDate">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                <input type="date" id="taskEndDate" readonly style="background-color: #f5f5f5;">
            </div>
        </div>
        
        <button type="submit" class="btn">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
    </form>
</div>

<!-- –ö–∞–Ω–±–∞–Ω –¥–æ—Å–∫–∞ -->
<div id="kanban-view">
    <div class="kanban-board">
        <div class="kanban-column" data-status="planned">
            <h3>üìã –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ (<span id="planned-count">0</span>)</h3>
            <div class="tasks-list" id="planned-list">
                <!-- –ó–∞–¥–∞—á–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
        
        <div class="kanban-column" data-status="in_progress">
            <h3>üîÑ –í —Ä–∞–±–æ—Ç–µ (<span id="in-progress-count">0</span>)</h3>
            <div class="tasks-list" id="in-progress-list">
                <!-- –ó–∞–¥–∞—á–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
        
        <div class="kanban-column" data-status="completed">
            <h3>‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ (<span id="completed-count">0</span>)</h3>
            <div class="tasks-list" id="completed-list">
                <!-- –ó–∞–¥–∞—á–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
<div id="list-view" class="tasks-list-view" style="display: none;">
    <div id="tasks-list-container">
        <!-- –ó–∞–¥–∞—á–∏ –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞ -->
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</h3>
        <form id="editTaskForm">
            <input type="hidden" id="editTaskId">
            <input type="hidden" id="editTaskType">
            
            <div class="form-group">
                <label for="editTaskTitle">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                <input type="text" id="editTaskTitle" required>
            </div>
            
            <div class="form-group">
                <label for="editTaskDescription">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea id="editTaskDescription" rows="3"></textarea>
            </div>
            
            <div id="project-info" class="project-info" style="display: none;">
                <div class="form-group">
                    <label>–ü—Ä–æ–µ–∫—Ç:</label>
                    <span id="editProjectName" class="project-name"></span>
                </div>
            </div>
            
            <div class="date-fields">
                <div class="field-group">
                    <label for="editStartDate">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
                    <input type="date" id="editStartDate">
                </div>
                <div class="field-group">
                    <label for="editEndDate">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                    <input type="date" id="editEndDate">
                </div>
                <div class="field-group">
                    <label for="editDuration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–µ–π):</label>
                    <input type="number" id="editDuration" min="1">
                </div>
            </div>
            
            <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" id="deleteTaskBtn" class="btn btn-danger" style="display: none;">–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É</button>
            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
        </form>
    </div>
</div>

<style>
.tasks-type-toggle {
    margin-bottom: 20px;
    text-align: center;
}

.type-toggle-btn {
    padding: 10px 20px;
    margin: 0 5px;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    border-radius: 5px;
}

.type-toggle-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.project-info {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 15px;
}

.project-name {
    font-weight: bold;
    color: #007bff;
}

.task-project-badge {
    display: inline-block;
    background: #e9ecef;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    margin-left: 10px;
    color: #6c757d;
}

.tasks-filter {
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.tasks-filter label {
    font-weight: bold;
    color: #333;
}

.task-type-select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background: white;
    font-size: 14px;
    min-width: 200px;
    cursor: pointer;
}

.task-type-select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

</style>
{% endblock %}

{% block scripts %}
<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let allTasks = [];
    let currentView = 'kanban';
    let currentType = 'all'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
        loadTasks();
        initTypeFilter(); // ‚Üê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –§–ò–õ–¨–¢–†–ê
        initViewToggle();
        initTaskForm();
        initEditForm();
        initDateCalculations();
        initEditDateCalculations();
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á
    async function loadTasks() {
        try {
            console.log('–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∑–∞–¥–∞—á...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏
            const personalResponse = await fetch('/api/personal/tasks');
            const personalTasks = await personalResponse.json();
            console.log('–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏:', personalTasks);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            const assignedResponse = await fetch('/api/my/assigned-tasks');
            const assignedTasks = await assignedResponse.json();
            console.log('–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:', assignedTasks);
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∑–∞–¥–∞—á–∏
            allTasks = [
                ...personalTasks.map(task => ({ ...task, type: 'personal' })),
                ...assignedTasks.map(task => ({ ...task, type: 'project_task' }))
            ];
            
            console.log('–í—Å–µ –∑–∞–¥–∞—á–∏:', allTasks);
            
            renderTasks();
            updateStatistics();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á');
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á
    function initTypeFilter() {
        const filterSelect = document.getElementById('taskTypeFilter');
        const taskForm = document.getElementById('personal-task-form');
        
        filterSelect.addEventListener('change', function() {
            currentType = this.value;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á
            if (currentType === 'personal') {
                taskForm.style.display = 'block';
            } else {
                taskForm.style.display = 'none';
            }
            
            renderTasks();
        });
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º "–í—Å–µ –∑–∞–¥–∞—á–∏" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        filterSelect.value = 'all';
        currentType = 'all';
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –ø–æ —Ç–µ–∫—É—â–µ–º—É —Ç–∏–ø—É
    function getFilteredTasks() {
        switch (currentType) {
            case 'personal':
                return allTasks.filter(task => task.type === 'personal');
            case 'assigned':
                return allTasks.filter(task => task.type === 'project_task');
            case 'all':
            default:
                return allTasks;
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∞
    function initViewToggle() {
        const toggleBtns = document.querySelectorAll('.view-toggle-btn');
        
        toggleBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                toggleBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentView = this.dataset.view;
                switchView(currentView);
            });
        });
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –∫–∞–Ω–±–∞–Ω–æ–º –∏ —Å–ø–∏—Å–∫–æ–º
    function switchView(view) {
        const kanbanView = document.getElementById('kanban-view');
        const listView = document.getElementById('list-view');
        
        if (view === 'kanban') {
            kanbanView.style.display = 'block';
            listView.style.display = 'none';
            initDragAndDrop();
        } else {
            kanbanView.style.display = 'none';
            listView.style.display = 'block';
            renderListView();
        }
    }

    // –†–µ–Ω–¥–µ—Ä –∑–∞–¥–∞—á
    function renderTasks() {
        renderKanbanView();
        if (currentView === 'list') {
            renderListView();
        }
    }

    // –†–µ–Ω–¥–µ—Ä –∫–∞–Ω–±–∞–Ω –¥–æ—Å–∫–∏
    function renderKanbanView() {
        const columns = {
            'planned': document.getElementById('planned-list'),
            'in_progress': document.getElementById('in-progress-list'),
            'completed': document.getElementById('completed-list')
        };

        // –û—á–∏—â–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏
        Object.values(columns).forEach(column => {
            column.innerHTML = '';
        });

        const filteredTasks = getFilteredTasks();
        const counters = { 'planned': 0, 'in_progress': 0, 'completed': 0 };

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ –∑–∞–¥–∞—á–∞–º–∏
        filteredTasks.forEach(task => {
            counters[task.status]++;
            const taskElement = createTaskElement(task);
            columns[task.status].appendChild(taskElement);
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
        document.getElementById('planned-count').textContent = counters.planned;
        document.getElementById('in-progress-count').textContent = counters.in_progress;
        document.getElementById('completed-count').textContent = counters.completed;

        initDragAndDrop();
    }

    // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á
    function renderListView() {
        const container = document.getElementById('tasks-list-container');
        container.innerHTML = '';

        const filteredTasks = getFilteredTasks();

        if (filteredTasks.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>–ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç</h3>
                    <p>${getEmptyStateMessage()}</p>
                </div>
            `;
            return;
        }

        filteredTasks.forEach(task => {
            const taskElement = createListTaskElement(task);
            container.appendChild(taskElement);
        });
    }

    // –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    function getEmptyStateMessage() {
        switch (currentType) {
            case 'personal': return '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á';
            case 'assigned': return '–í–∞–º –µ—â–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–∏–ª–∏ –∑–∞–¥–∞—á–∏ –≤ –ø—Ä–æ–µ–∫—Ç–∞—Ö';
            case 'all': return '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á';
            default: return '–ó–∞–¥–∞—á –Ω–µ—Ç';
        }
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∑–∞–¥–∞—á–∏ –¥–ª—è –∫–∞–Ω–±–∞–Ω–∞
    function createTaskElement(task) {
        const taskDiv = document.createElement('div');
        taskDiv.className = 'task-card';
        taskDiv.draggable = true;
        taskDiv.dataset.taskId = task.id;
        taskDiv.dataset.taskType = task.type;
        
        const projectBadge = task.project_name ? 
            `<span class="task-project-badge">${escapeHtml(task.project_name)}</span>` : '';
        
        taskDiv.innerHTML = `
            <div class="task-header">
                <h4>${escapeHtml(task.title)} ${projectBadge}</h4>
                <button class="edit-btn" onclick="openEditModal(${task.id}, '${task.type}')">‚úèÔ∏è</button>
            </div>
            ${task.description ? `<p>${escapeHtml(task.description)}</p>` : ''}
            <div class="task-dates">
                <div class="date-info"><strong>–ù–∞—á–∞–ª–æ:</strong> ${task.start_date || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                <div class="date-info"><strong>–û–∫–æ–Ω—á–∞–Ω–∏–µ:</strong> ${task.end_date || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                <div class="date-info"><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${task.duration || 0} –¥–Ω.</div>
            </div>
        `;
        
        return taskDiv;
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∑–∞–¥–∞—á–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞
    function createListTaskElement(task) {
        const taskDiv = document.createElement('div');
        taskDiv.className = `task-list-item ${task.status}`;
        
        const statusIcons = {
            'planned': 'üìã',
            'in_progress': 'üîÑ', 
            'completed': '‚úÖ'
        };
        
        const projectBadge = task.project_name ? 
            `<span class="task-project-badge">${escapeHtml(task.project_name)}</span>` : '';
        
        taskDiv.innerHTML = `
            <div class="task-info">
                <h4>${statusIcons[task.status]} ${escapeHtml(task.title)} ${projectBadge}</h4>
                ${task.description ? `<p>${escapeHtml(task.description)}</p>` : ''}
                <div class="task-dates">
                    <span><strong>–î–∞—Ç—ã:</strong> ${task.start_date || '?'} - ${task.end_date || '?'}</span>
                    <span style="margin-left: 15px;"><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${task.duration || 0} –¥–Ω.</span>
                </div>
            </div>
            <div class="task-actions">
                <button class="btn" onclick="openEditModal(${task.id}, '${task.type}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        `;
        
        return taskDiv;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è drag & drop (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á)
    function initDragAndDrop() {
        const taskCards = document.querySelectorAll('.task-card');
        const columns = document.querySelectorAll('.kanban-column');

        let draggedTask = null;

        taskCards.forEach(card => {
            card.addEventListener('dragstart', function(e) {
                // –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á
                if (this.dataset.taskType === 'personal') {
                    draggedTask = this;
                    this.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', this.dataset.taskId);
                } else {
                    e.preventDefault();
                }
            });

            card.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                draggedTask = null;
            });
        });

        columns.forEach(column => {
            column.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.backgroundColor = '#e9ecef';
            });

            column.addEventListener('dragleave', function() {
                this.style.backgroundColor = '';
            });

            column.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.backgroundColor = '';
                
                if (draggedTask && draggedTask.dataset.taskType === 'personal') {
                    const taskId = draggedTask.dataset.taskId;
                    const newStatus = this.dataset.status;
                    const tasksList = this.querySelector('.tasks-list');
                    
                    tasksList.appendChild(draggedTask);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                    updateTaskStatus(taskId, newStatus, 'personal');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    updateStatistics();
                }
            });
        });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function updateStatistics() {
        const filteredTasks = getFilteredTasks();
        const stats = {
            'total': filteredTasks.length,
            'planned': filteredTasks.filter(t => t.status === 'planned').length,
            'in_progress': filteredTasks.filter(t => t.status === 'in_progress').length,
            'completed': filteredTasks.filter(t => t.status === 'completed').length
        };

        document.getElementById('total-tasks').textContent = stats.total;
        document.getElementById('planned-tasks').textContent = stats.planned;
        document.getElementById('progress-tasks').textContent = stats.in_progress;
        document.getElementById('completed-tasks').textContent = stats.completed;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
    function initTaskForm() {
        const taskForm = document.getElementById('taskForm');
        
        taskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const startDate = document.getElementById('taskStartDate').value;
            const endDate = document.getElementById('taskEndDate').value;
            const duration = parseInt(document.getElementById('taskDuration').value);
            
            createPersonalTask(title, description, duration, startDate, endDate);
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function initEditForm() {
        const modal = document.getElementById('editModal');
        const closeBtn = document.querySelector('.close');
        const editForm = document.getElementById('editTaskForm');
        
        closeBtn.onclick = closeEditModal;
        
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            saveTaskChanges();
        });

        document.getElementById('deleteTaskBtn').addEventListener('click', function() {
            const taskId = document.getElementById('editTaskId').value;
            const taskType = document.getElementById('editTaskType').value;
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) {
                if (taskType === 'personal') {
                    deletePersonalTask(taskId);
                } else {
                    alert('–ó–∞–¥–∞—á–∏ –∏–∑ –ø—Ä–æ–µ–∫—Ç–æ–≤ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤ —Å–∞–º–æ–º –ø—Ä–æ–µ–∫—Ç–µ');
                }
            }
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –¥–∞—Ç –¥–ª—è —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è
    function initDateCalculations() {
        const startDateInput = document.getElementById('taskStartDate');
        const endDateInput = document.getElementById('taskEndDate');
        const durationInput = document.getElementById('taskDuration');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const today = new Date().toISOString().split('T')[0];
        if (!startDateInput.value) {
            startDateInput.value = today;
        }
        updateEndDateFromStartAndDuration();
        
        // –°–ª—É—à–∞—Ç–µ–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        startDateInput.addEventListener('change', updateEndDateFromStartAndDuration);
        durationInput.addEventListener('change', updateEndDateFromStartAndDuration);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –¥–∞—Ç –¥–ª—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function initEditDateCalculations() {
        const startDateInput = document.getElementById('editStartDate');
        const endDateInput = document.getElementById('editEndDate');
        const durationInput = document.getElementById('editDuration');
        
        startDateInput.addEventListener('change', updateEditEndDateFromStartAndDuration);
        durationInput.addEventListener('change', updateEditEndDateFromStartAndDuration);
        endDateInput.addEventListener('change', updateEditDurationFromStartAndEnd);
    }

    // –§—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞ –¥–∞—Ç
    function updateEndDateFromStartAndDuration() {
        const startDate = document.getElementById('taskStartDate').value;
        const duration = parseInt(document.getElementById('taskDuration').value);
        
        if (startDate && duration) {
            const start = new Date(startDate);
            const endDate = new Date(start.getTime() + (duration - 1) * 24 * 60 * 60 * 1000);
            document.getElementById('taskEndDate').value = endDate.toISOString().split('T')[0];
        }
    }

    function updateEditEndDateFromStartAndDuration() {
        const startDate = document.getElementById('editStartDate').value;
        const duration = parseInt(document.getElementById('editDuration').value);
        
        if (startDate && duration) {
            const start = new Date(startDate);
            const endDate = new Date(start.getTime() + (duration - 1) * 24 * 60 * 60 * 1000);
            document.getElementById('editEndDate').value = endDate.toISOString().split('T')[0];
        }
    }

    function updateEditDurationFromStartAndEnd() {
        const startDate = document.getElementById('editStartDate').value;
        const endDate = document.getElementById('editEndDate').value;
        
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const duration = Math.ceil((end - start) / (24 * 60 * 60 * 1000)) + 1;
            document.getElementById('editDuration').value = duration;
        }
    }

    // API —Ñ—É–Ω–∫—Ü–∏–∏
    async function createPersonalTask(title, description, duration, startDate, endDate) {
        try {
            const response = await fetch('/api/personal/task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title,
                    description,
                    duration,
                    start_date: startDate,
                    end_date: endDate
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                document.getElementById('taskForm').reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('taskStartDate').value = today;
                document.getElementById('taskDuration').value = 1;
                updateEndDateFromStartAndDuration();
                
                loadTasks();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + result.error);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
        }
    }

    async function updateTaskStatus(taskId, newStatus, taskType) {
        try {
            let endpoint = '';
            if (taskType === 'personal') {
                endpoint = `/api/personal/task/${taskId}/status`;
            } else {
                endpoint = `/api/task/${taskId}/status`;
            }
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    status: newStatus,
                    position: 0
                })
            });
            
            const result = await response.json();
            if (!result.success) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
                loadTasks();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
            loadTasks();
        }
    }

    async function openEditModal(taskId, taskType) {
        try {
            const task = allTasks.find(t => t.id == taskId && t.type === taskType);
            
            if (task) {
                document.getElementById('editTaskId').value = task.id;
                document.getElementById('editTaskType').value = task.type;
                document.getElementById('editTaskTitle').value = task.title;
                document.getElementById('editTaskDescription').value = task.description || '';
                document.getElementById('editStartDate').value = task.start_date || '';
                document.getElementById('editEndDate').value = task.end_date || '';
                document.getElementById('editDuration').value = task.duration || 1;
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏
                const projectInfo = document.getElementById('project-info');
                const deleteBtn = document.getElementById('deleteTaskBtn');
                
                if (task.type === 'project_task') {
                    projectInfo.style.display = 'block';
                    document.getElementById('editProjectName').textContent = task.project_name;
                    deleteBtn.style.display = 'none';
                } else {
                    projectInfo.style.display = 'none';
                    deleteBtn.style.display = 'block';
                }
                
                document.getElementById('editModal').style.display = 'block';
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á–∏');
        }
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    async function saveTaskChanges() {
        const taskId = document.getElementById('editTaskId').value;
        const taskType = document.getElementById('editTaskType').value;
        const title = document.getElementById('editTaskTitle').value;
        const description = document.getElementById('editTaskDescription').value;
        const startDate = document.getElementById('editStartDate').value;
        const endDate = document.getElementById('editEndDate').value;
        const duration = parseInt(document.getElementById('editDuration').value);
        
        try {
            let updateEndpoint = '';
            let datesEndpoint = '';
            
            if (taskType === 'personal') {
                updateEndpoint = `/api/personal/task/${taskId}`;
                datesEndpoint = `/api/personal/task/${taskId}/dates`;
            } else {
                updateEndpoint = `/api/task/${taskId}`;
                datesEndpoint = `/api/task/${taskId}/dates`;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
            const updateResponse = await fetch(updateEndpoint, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    description: description
                })
            });

            const updateResult = await updateResponse.json();
            
            if (!updateResult.success) {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + updateResult.error);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—ã –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            const datesResponse = await fetch(datesEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    start_date: startDate,
                    end_date: endDate,
                    duration: duration
                })
            });

            const datesResult = await datesResponse.json();
            
            if (datesResult.success) {
                closeEditModal();
                loadTasks();
            } else {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞—Ç: ' + datesResult.error);
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message);
        }
    }

    async function deletePersonalTask(taskId) {
        try {
            const response = await fetch(`/api/personal/task/${taskId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                closeEditModal();
                loadTasks();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + result.error);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
        }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target == modal) {
            closeEditModal();
        }
    }
</script>
{% endblock %}